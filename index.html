<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KBR Timesheet Helper</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%230066cc'/%3E%3Ccircle cx='50' cy='50' r='40' fill='white'/%3E%3Cpath d='M50 20 L50 50 L70 50' stroke='%230066cc' stroke-width='4' stroke-linecap='round' fill='none'/%3E%3Ccircle cx='50' cy='50' r='3' fill='%230066cc'/%3E%3C/svg%3E">
    <!-- Fuzzy Search Library -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            color: #333;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header {
            margin-bottom: 20px;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 15px;
            /* Flexbox layout for logo placement */
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 30px;
        }

        h1 {
            color: #0066cc;
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* Header content wrapper */
        .header-content {
            flex: 1 1 500px;
            max-width: 1200px;
            min-width: 0;
        }

        /* KBR Logo styling */
        .header-logo {
            height: 45px;
            width: auto;
            flex-shrink: 0;
        }

        /* Save indicator */
        .save-indicator {
            margin-left: auto;
            font-size: 13px;
            color: #888;
            flex-shrink: 0;
        }

        .save-indicator.saving {
            color: #666;
        }

        .save-indicator.error {
            color: #dc3545;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .week-nav button {
            padding: 8px 16px;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            box-sizing: border-box;
        }

        .week-nav button:hover {
            background-color: #0052a3;
        }

        .week-display {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .validation-panel {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 4px;
            display: none;
        }

        .validation-panel.has-errors {
            display: block;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .validation-panel.has-warnings {
            display: block;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }

        .validation-panel h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .validation-panel ul {
            margin-left: 20px;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8f9fa;
        }

        th {
            background-color: #0066cc;
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #004c99;
            white-space: nowrap;
        }

        td {
            padding: 4px 6px;
            border: 1px solid #ddd;
        }

        /* Category-based row coloring */
        tbody tr.category-bd {
            background-color: rgba(255, 152, 0, 0.15); /* Business Development - Orange */
        }

        tbody tr.category-o {
            background-color: rgba(156, 39, 176, 0.15); /* Overheads - Purple */
        }

        tbody tr.category-t {
            background-color: rgba(76, 175, 80, 0.15); /* Time Off - Green */
        }

        tbody tr.category-p {
            background-color: rgba(33, 150, 243, 0.15); /* Productive - Blue */
        }

        tbody tr:hover {
            filter: brightness(95%);
        }

        input, select {
            width: 100%;
            padding: 4px 5px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 12px;
            background-color: #ffffff; /* Solid white background for readability */
        }

        input:focus, select:focus {
            outline: 2px solid #0066cc;
            outline-offset: 1px;
        }

        input.hours-input {
            width: 100%;
            text-align: right;
        }

        .zero-value {
            color: #999;
        }

        .zero-value:focus {
            color: #333;
        }

        .row-total.zero-value {
            color: #999;
        }

        input.validation-error,
        select.validation-error {
            border-color: #dc3545;
            background-color: #ffe6e6;
        }

        input.validation-warning,
        select.validation-warning {
            border-color: #ffc107;
            background-color: #fff8e1;
        }

        .delete-btn {
            display: inline-block;
            padding: 4px 8px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            min-width: 28px;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .duplicate-btn {
            display: inline-block;
            padding: 4px 8px;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            min-width: 28px;
        }

        .duplicate-btn:hover {
            background-color: #0052a3;
        }

        /* Copy to Current Week button */
        .copy-to-current-btn {
            display: inline-block;
            padding: 4px 8px;
            background-color: #28a745;  /* Green */
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            min-width: 28px;
        }

        .copy-to-current-btn:hover {
            background-color: #218838;  /* Darker green on hover */
        }

        .action-cell {
            display: flex;
            gap: 2px;
            align-items: center;
            white-space: nowrap;
        }

        .action-cell button {
            display: inline-flex;
        }

        .totals-row {
            font-weight: bold;
            background-color: #e3f2fd !important;
        }

        .totals-row td {
            padding: 10px 8px;
        }

        /* Sortable Column Headers */
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        th.sortable:hover {
            background-color: #e8e8e8;
        }

        .sort-indicator {
            display: inline-block;
            font-size: 10px;
            color: #999;
            margin-left: 3px;
            transition: color 0.2s;
        }

        .sort-indicator.active {
            color: #007bff;
            font-weight: bold;
        }

        /* Ensure narrow columns still show indicator */
        th.cat-col .sort-indicator {
            font-size: 9px;
            margin-left: 2px;
        }

        /* Category Column */
        .cat-col {
            width: 40px;
            text-align: center;
        }

        .category-cell {
            text-align: center;
            background-color: #f9f9f9;
            color: #666;
            font-weight: 500;
            font-size: 13px;
            cursor: help;
            padding: 8px 4px;
        }

        /* Weekly Summary by Category */
        .category-summary {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }

        .category-summary h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .category-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .category-card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background-color: #f9f9f9;
            text-align: center;
        }

        .category-card.bd-card {
            border-left: 4px solid #ff9800;
        }

        .category-card.o-card {
            border-left: 4px solid #9c27b0;
        }

        .category-card.t-card {
            border-left: 4px solid #4caf50;
        }

        .category-card.p-card {
            border-left: 4px solid #2196f3;
        }

        .category-title {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
        }

        .category-hours {
            font-size: 20px;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 4px;
        }

        .category-percent {
            font-size: 14px;
            color: #666;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .category-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .category-cards {
                grid-template-columns: 1fr;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #0066cc;
        }

        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close-btn:hover {
            color: #000;
        }

        /* Calendar Modal Styles */
        .calendar-modal-content {
            max-width: 420px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-header h3 {
            margin: 0;
            color: #0066cc;
            font-size: 18px;
        }

        .calendar-nav-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }

        .calendar-nav-btn:hover {
            background-color: #f0f0f0;
            border-color: #bbb;
        }

        .calendar-nav-btn:focus {
            outline: 2px solid #0066cc;
            outline-offset: 2px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-weekday-header {
            text-align: center;
            font-weight: 600;
            color: #666;
            padding: 8px 0;
            font-size: 12px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: border-color 0.15s, transform 0.15s, box-shadow 0.15s;
            position: relative;
        }

        .calendar-day:hover {
            border-color: #0066cc;
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2);
            transform: scale(1.05);
            z-index: 1;
        }

        .calendar-day:focus {
            outline: 2px solid #0066cc;
            outline-offset: 2px;
            z-index: 2;
        }

        .calendar-day.other-month {
            color: #bbb;
            background-color: #f9f9f9;
        }

        .calendar-day.other-month:hover {
            border-color: #ccc;
            box-shadow: none;
            transform: none;
        }

        .calendar-day.today {
            border: 2px solid #0066cc;
            font-weight: 700;
        }

        .calendar-day.current-week {
            box-shadow: inset 0 0 0 2px rgba(0, 102, 204, 0.25);
        }

        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            font-size: 12px;
            color: #666;
        }

        .calendar-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .calendar-legend-color {
            width: 18px;
            height: 18px;
            border-radius: 3px;
        }

        @media (max-width: 480px) {
            .calendar-modal-content {
                padding: 20px;
            }

            .calendar-day {
                font-size: 12px;
            }

            .calendar-legend {
                flex-wrap: wrap;
                gap: 12px;
            }

            .calendar-nav-btn {
                padding: 6px 10px;
            }
        }

        .template-list {
            list-style: none;
            margin-top: 15px;
        }

        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .template-item:hover {
            background-color: #f8f9fa;
        }

        .template-actions {
            display: flex;
            gap: 5px;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .week-rows-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .week-row-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .week-row-item:hover {
            background-color: #f8f9fa;
        }

        .week-row-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        /* Checkbox label alignment fix */
        label.checkbox-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            line-height: 1.2;
            white-space: nowrap;
        }

        label.checkbox-label > input[type="checkbox"] {
            margin: 0;
        }

        .week-row-details {
            flex: 1;
        }

        .week-row-details strong {
            display: block;
            margin-bottom: 3px;
        }

        .week-row-details small {
            color: #666;
        }

        .hidden {
            display: none;
        }

        /* Copy Success Toast Notification */
        .copy-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
            max-width: 500px;
        }

        .copy-toast.fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast-view-btn {
            background-color: white;
            color: #28a745;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .toast-view-btn:hover {
            background-color: #f0f0f0;
        }

        .toast-dismiss-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .toast-dismiss-btn:hover {
            opacity: 1;
        }

        /* Print styles */
        @media print {
            body {
                background-color: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 10px;
            }

            .controls, .week-nav, .btn, .delete-btn, .validation-panel {
                display: none !important;
            }

            table {
                font-size: 10px;
                min-width: 100%;
            }

            th, td {
                padding: 4px;
            }

            thead {
                position: static;
            }
        }

        /* Expected Hours */
        .expected-hours-container {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .expected-hours-text {
            font-size: 14px;
            color: #333;
        }

        .edit-link {
            color: #5a7fa0;
            text-decoration: none;
            cursor: pointer;
            font-size: 14px;
            margin-left: 6px;
        }

        .edit-link:hover,
        .edit-link:focus {
            text-decoration: underline;
            color: #4a6f90;
        }

        /* Week Picker */
        .week-display-btn {
            background: transparent;
            border: none;
            font-weight: bold;
            font-size: 16px;
            color: #333;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .week-display-btn:hover {
            background: #f0f0f0;
            text-decoration: underline;
        }

        .this-week-btn {
            background: #f0f0f0;
            border: 1px solid #0066cc;
            padding: 7px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            margin-left: 15px;
            color: #0066cc;
            font-weight: 500;
            box-sizing: border-box;
        }

        .this-week-btn:hover {
            background: #e3f2fd;
            border-color: #0052a3;
        }

        #hideEmptyRowsBtn {
            background: #f0f0f0;
            border: 1px solid #6c757d;
            padding: 7px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            margin-left: 15px;
            color: #6c757d;
            font-weight: 500;
            box-sizing: border-box;
        }

        #hideEmptyRowsBtn:hover {
            background: #e9ecef;
            border-color: #5a6268;
        }

        #hideEmptyRowsBtn.active {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        #hideEmptyRowsBtn.active:hover {
            background: #218838;
            border-color: #1e7e34;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Button Groups */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .button-group-divider {
            width: 1px;
            height: 24px;
            background-color: #ddd;
            margin: 0 5px;
        }

        /* Dropdown Button */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-btn {
            padding: 10px 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dropdown-btn:hover {
            background-color: #c82333;
        }

        .dropdown-btn::after {
            content: '‚ñº';
            font-size: 10px;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            z-index: 100;
            margin-top: 4px;
            border: 1px solid #ddd;
        }

        .dropdown-container:hover .dropdown-menu,
        .dropdown-container:focus-within .dropdown-menu {
            display: block;
        }

        .dropdown-menu button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }

        .dropdown-menu button:hover {
            background-color: #f8f9fa;
        }

        .dropdown-menu button.dropdown-danger {
            color: #dc3545;
        }

        .dropdown-menu button.dropdown-danger:hover {
            background-color: #f8d7da;
        }

        .dropdown-menu hr {
            margin: 5px 0;
            border: none;
            border-top: 1px solid #eee;
        }

        /* ==================== DOCUMENTATION SECTIONS ==================== */

        .documentation-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }

        /* Accordion Styling */
        .doc-accordion {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .doc-accordion-header {
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            padding: 15px 20px;
            cursor: pointer;
            list-style: none;
            border-bottom: 1px solid #ddd;
            transition: background-color 0.2s;
        }

        .doc-accordion-header:hover {
            background: #e9ecef;
        }

        .doc-accordion-header h2 {
            margin: 0;
            color: #0066cc;
            font-size: 18px;
            display: inline-block;
        }

        .doc-accordion-header::marker {
            content: '‚ñ∂ ';
            color: #0066cc;
        }

        .doc-accordion[open] .doc-accordion-header::marker {
            content: '‚ñº ';
        }

        .doc-accordion-content {
            padding: 20px;
        }

        .doc-intro {
            font-size: 15px;
            color: #666;
            margin-bottom: 20px;
        }

        /* Import Steps */
        .import-steps {
            display: grid;
            gap: 20px;
        }

        .step-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            display: grid;
            grid-template-columns: auto 1fr 250px;
            grid-template-rows: auto auto;
            gap: 15px;
            align-items: start;
        }

        .step-number {
            grid-row: 1 / -1;
            background: #0066cc;
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }

        .step-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .step-card p {
            margin: 0 0 10px 0;
            color: #666;
        }

        .step-card ul {
            margin: 10px 0;
            padding-left: 20px;
            color: #666;
        }

        .step-card ul li {
            margin: 5px 0;
        }

        .step-image {
            grid-row: 1 / -1;
            grid-column: 3;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-image img {
            max-width: 100%;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .step-image img:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .lightbox-close:hover {
            opacity: 1;
        }

        .lightbox-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 14px;
            opacity: 0.6;
        }

        /* Tip Callout */
        .doc-tip {
            background: #e8f5e9;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            color: #333;
        }

        .doc-tip strong {
            color: #28a745;
        }

        /* FAQ Search */
        .faq-search-container {
            margin-bottom: 20px;
        }

        .faq-search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .faq-search-input:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
        }

        /* FAQ Index */
        .faq-index {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .faq-index h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
        }

        .faq-index ul {
            margin: 0;
            padding: 0;
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }

        .faq-index li {
            margin: 0;
        }

        .faq-index a {
            color: #0066cc;
            text-decoration: none;
            font-size: 14px;
        }

        .faq-index a:hover {
            text-decoration: underline;
        }

        /* FAQ Categories */
        .faq-category {
            margin-bottom: 30px;
        }

        .faq-category h3 {
            color: #0066cc;
            font-size: 16px;
            margin: 0 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #0066cc;
        }

        /* FAQ Items */
        .faq-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            padding: 15px;
            transition: box-shadow 0.2s;
        }

        .faq-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .faq-item.hidden {
            display: none;
        }

        .faq-question {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .faq-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .faq-badge.error {
            background: #dc3545;
            color: white;
        }

        .faq-badge.warning {
            background: #ffc107;
            color: #333;
        }

        .faq-badge.info {
            background: #0066cc;
            color: white;
        }

        .faq-answer {
            color: #666;
            line-height: 1.6;
        }

        .faq-answer p {
            margin: 8px 0;
        }

        .faq-answer strong {
            color: #333;
        }

        .faq-answer code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        /* Responsive Design for Documentation */
        @media (max-width: 768px) {
            .step-card {
                grid-template-columns: auto 1fr;
                grid-template-rows: auto auto auto;
            }

            .step-image {
                grid-row: 3;
                grid-column: 1 / -1;
            }

            .step-image img {
                max-height: 150px;
            }

            .faq-index ul {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            .documentation-section {
                page-break-before: always;
            }

            .doc-accordion {
                border: none;
            }

            .doc-accordion-header::marker {
                content: '';
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>KBR Timesheet Helper</h1>
                <div class="expected-hours-container">
                    <span class="expected-hours-text">Expected hours per week: <span id="expectedHoursValue">38</span> hours</span>
                    <a href="#" class="edit-link" onclick="app.showExpectedHoursModal(); return false;"
                       aria-label="Edit expected hours per week">(edit)</a>
                </div>
                <div class="work-location-container">
                    <span class="work-location-text">Work Location: <span id="workLocationValue">Brisbane (03600100000)</span></span>
                    <a href="#" class="edit-link" onclick="app.showWorkLocationModal(); return false;"
                       aria-label="Edit work location">(edit)</a>
                </div>
                <div class="cost-type-container">
                    <span class="cost-type-text">Cost Type: <span id="costTypeValue">Not set</span></span>
                    <a href="#" class="edit-link" onclick="app.showCostTypeModal(); return false;"
                       aria-label="Edit cost type">(edit)</a>
                </div>
                <div class="week-nav">
                    <button onclick="app.previousWeek()">‚Üê Previous Week</button>
                    <button class="week-display-btn" onclick="app.openWeekPicker()"
                            aria-label="Choose week" id="weekDisplay">
                        Week of...
                    </button>
                    <button onclick="app.nextWeek()">Next Week ‚Üí</button>
                    <button class="this-week-btn" onclick="app.goToCurrentWeek()"
                            aria-label="Go to current week" title="Jump to this week">
                        üìç This Week
                    </button>
                    <button id="clearSortBtn" onclick="app.clearSort()"
                            aria-label="Clear sort and restore original order"
                            title="Clear sort and restore original order"
                            style="display: none;">
                        Clear Sort ‚úï
                    </button>
                    <button id="hideEmptyRowsBtn" onclick="app.toggleHideEmptyRows()"
                            aria-label="Hide rows with no hours"
                            title="Hide rows with no hours">
                        Hide Empty Rows
                    </button>
                    <input type="date" id="weekPicker" class="sr-only"
                           onchange="app.jumpToWeek(this.value)"
                           aria-label="Select date to jump to week">
                </div>
            </div>
            <span id="saveIndicator" class="save-indicator">Saved</span>
            <img src="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20width='270.73'%20height='149.92'%20viewBox='0%200%20500%20280'%3E%3Cg%3E%3Crect%20x='153.2'%20y='73.7'%20width='26.1'%20height='27.2'%20fill='%2300783f'/%3E%3Crect%20x='158.4'%20y='26.8'%20width='20.7'%20height='20.7'/%3E%3Crect%20x='193.3'%20y='35.4'%20width='10.8'%20height='10.8'%20fill='%23a2c7e2'/%3E%3Crect%20x='212.5'%20y='38.4'%20width='6.7'%20height='6.7'/%3E%3Crect%20x='211'%20y='51.3'%20width='14.2'%20height='14.2'%20fill='%2300205c'/%3E%3Crect%20x='197.9'%20y='71.8'%20width='23.6'%20height='23.6'%20fill='%23a2c7e2'/%3E%3Crect%20x='186.7'%20y='53.5'%20width='10.2'%20height='10.2'%20fill='%2300783f'/%3E%3Crect%20x='230'%20y='68.4'%20width='8'%20height='8'%20fill='%2300783f'/%3E%3Crect%20x='187.3'%20y='21'%20width='7.6'%20height='7.6'%20fill='%2300205c'/%3E%3Crect%20x='167.8'%20y='56.8'%20width='10.2'%20height='10.2'%20fill='%23a2c7e2'/%3E%3Cpath%20d='M174.2,168.3c-9.7,1.4-19.5,1-30,1-43.4,0-82.1-13.1-99.7-31.3-8.6-31.5-2.4-61,9.1-81.6-5.4-2.7-9.5-5.9-13.7-9.1-20.2,29.1-24.2,62.2-15.2,92.2,17,18.9,57.3,33.1,101.7,33.1,17.3,0.1,33.2-0.8,47.8-4.3zm-117-1.6c-10.3-2.5-20.3-9-27.9-14.7,18.7,40.9,59.8,66,100.5,66.1,3.4,0,8.7,0.2,11.9-0.1-31.3-2.5-64.2-19.2-84.5-51.3zM99.8,64.9c33.9,5.3,65.2,0.6,65.2,0.6-26.8,0.9-47.6-2-63.4-6.1-0.5,1.3-1.2,3.2-1.8,5.5zM80.5,79.4c-5.1,27.6-3.6,55.7,4.6,72.4-3.4-17.9-3.1-41.6,1.4-64.9,7-36.5,27.5-60.7,46.2-72.5-14.5,3-33.1,18.5-44.1,41C73.9,50.1,65.8,44.3,62.9,42,79.1,21,105.6,3.4,134.6,0,100.5-0.9,65.2,14.9,43.8,42.5c12,9.7,26.7,15.8,41.7,19.5-2.2,5.5-3.9,11.3-5,17.4zm148.2,73.3c0,0-13.8,40.1-55.1,58.4,0,0,50.5-15.9,67.5-69.6,0-0.1-7.3,7.5-12.4,11.2z'%20fill='%23004987'/%3E%3Cpath%20d='M339,181.7l-0.1-0.1c6.5-7.7,9.3-17.1,9.3-25.9v-0.4c0-20.5-14.7-41.1-47.5-41.1h-87.8l-49.6,54.9V114.2H132.4V260h30.9V201.5L219.8,260H303c13.8,0,24.9-2.7,33.8-8.2,12.3-7.7,19.4-20.7,19.4-35.6v-0.5c0-14-6.1-26.1-17.2-34zm-152.5,1.4l61-67.4v130.9zm138.2,33.1c0,13.1-10.8,18.7-28,18.7H278.1V139.5H296c14.4,0,22.3,5.7,22.3,15.9v0.4c0,11.5-9.5,16.4-24.5,16.4H286v25.4h13.2c16.4,0,25.5,6.6,25.5,18.1z'%20fill='%23004987'/%3E%3Cpath%20d='M471,260l-36.2-68.2c16.3-7.8,22.6-22.7,22.6-36.1v-0.4c0-20.5-14.7-41.1-47.5-41.1H356V260h30.8V139.4h18.6c14.4,0,22.3,5.7,22.3,15.9v0.4c0,11.5-9.5,16.4-24.5,16.4h-8.5v25.4h10.9L439,260Z'%20fill='%23004987'/%3E%3Cpath%20d='M54.8,26L59.3,14.3C59.4,14,59,13.8,58.9,14.1l-9.7,13,2-10.9C51.3,15.8,50.7,15.6,50.5,16l-5,10.1V9.7C45.5,9.4,45.1,9.4,45,9.6L40.7,25.2,38.6,14.4C38.5,14,37.9,14,37.9,14.4l-1.1,11.3-6-15.4C30.7,10,30.3,10.1,30.3,10.4L31.9,26.5,26,17.1C25.8,16.7,25.2,17,25.3,17.4l3.1,11-11.1-12.3c-0.2-0.2-0.5,0-0.4,0.3l7.3,14.4-8.8-6.5c-0.3-0.3-0.8,0.2-0.5,0.5l6.9,9.1-15-7.4C6.5,26.4,6.3,26.7,6.5,26.9L18.4,37.6,8,34.7C7.6,34.6,7.3,35.1,7.7,35.4l9.7,6L0.9,40c-0.3,0-0.4,0.4-0.1,0.5l15,5.7-10.8,1c-0.4,0-0.5,0.7,0,0.7l11.2,2.1-16,4.6c-0.3,0.1-0.2,0.5,0.1,0.5l16-0.1-9.7,4.9c-0.4,0.2-0.2,0.8,0.2,0.7L18,58.5,4.8,68.6c-0.2,0.2,0,0.5,0.2,0.4l15-5.9-7.3,8.1c-0.3,0.3,0.1,0.8,0.5,0.6l9.7-6-8.7,14.2c-0.1,0.2,0.2,0.5,0.4,0.3l8.5-7.8C30.4,50.4,44.9,34.7,54.8,26Z'%20fill='%23ffda00'/%3E%3C/g%3E%3C/svg%3E"
                 alt="KBR Logo"
                 class="header-logo">
        </header>

        <div class="controls">
            <!-- Row Actions -->
            <div class="button-group">
                <button class="btn" onclick="app.addRow()">+ Add Row</button>
                <button class="btn" onclick="app.showTemplates()">Add Template</button>
                <button class="btn" onclick="app.showAddPastRow()">Add Past Row</button>
                <button class="btn btn-secondary" onclick="app.showCopyFromWeek()">Copy from Other Week</button>
            </div>

            <div class="button-group-divider"></div>

            <!-- Export -->
            <div class="button-group">
                <button class="btn" onclick="app.exportCSV()">Export CSV</button>
            </div>

            <div class="button-group-divider"></div>

            <!-- Backup -->
            <div class="button-group">
                <button class="btn btn-secondary" onclick="app.exportJSON()">Export Backup</button>
                <button class="btn btn-secondary" onclick="app.importJSON()">Import Backup</button>
            </div>

            <div class="button-group-divider"></div>

            <!-- Cleanup Actions (Dropdown) -->
            <div class="dropdown-container">
                <button class="dropdown-btn" type="button">Cleanup</button>
                <div class="dropdown-menu">
                    <button onclick="app.showDeleteEmptyRowsModal()">Delete Empty Rows</button>
                    <button onclick="app.showClearAllHoursModal()">Clear All Hours</button>
                    <hr>
                    <button class="dropdown-danger" onclick="app.showDeleteOldWeeksModal()">Delete Old Weeks</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table id="timesheetTable">
                <thead>
                    <tr>
                        <th style="width: 60px;">Action</th>
                        <th style="width: 210px;" class="sortable" onclick="app.sortColumn('project')" aria-sort="none">
                            Project <span id="sort-project" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 200px;" class="sortable" onclick="app.sortColumn('projectTask')" aria-sort="none">
                            Project Task <span id="sort-projectTask" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 120px;" class="sortable" onclick="app.sortColumn('cbs')" aria-sort="none">
                            CBS <span id="sort-cbs" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 90px;" class="sortable" onclick="app.sortColumn('role')" aria-sort="none">
                            Role <span id="sort-role" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 90px;" class="sortable" onclick="app.sortColumn('type')" aria-sort="none">
                            Type <span id="sort-type" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 220px;" class="sortable" onclick="app.sortColumn('description')" aria-sort="none">
                            Description <span id="sort-description" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th class="cat-col sortable" onclick="app.sortColumn('category')" aria-sort="none">
                            Cat. <span id="sort-category" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 50px;" class="sortable" onclick="app.sortColumn('mon')" aria-sort="none">
                            Mon <span id="sort-mon" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 50px;" class="sortable" onclick="app.sortColumn('tue')" aria-sort="none">
                            Tue <span id="sort-tue" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 50px;" class="sortable" onclick="app.sortColumn('wed')" aria-sort="none">
                            Wed <span id="sort-wed" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 50px;" class="sortable" onclick="app.sortColumn('thu')" aria-sort="none">
                            Thu <span id="sort-thu" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 50px;" class="sortable" onclick="app.sortColumn('fri')" aria-sort="none">
                            Fri <span id="sort-fri" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 50px;" class="sortable" onclick="app.sortColumn('sat')" aria-sort="none">
                            Sat <span id="sort-sat" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 50px;" class="sortable" onclick="app.sortColumn('sun')" aria-sort="none">
                            Sun <span id="sort-sun" class="sort-indicator">‚ñæ</span>
                        </th>
                        <th style="width: 55px;" class="sortable" onclick="app.sortColumn('total')" aria-sort="none">
                            Total <span id="sort-total" class="sort-indicator">‚ñæ</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="timesheetBody">
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td colspan="8" style="text-align: right;">Daily Totals:</td>
                        <td id="totalMon">0</td>
                        <td id="totalTue">0</td>
                        <td id="totalWed">0</td>
                        <td id="totalThu">0</td>
                        <td id="totalFri">0</td>
                        <td id="totalSat">0</td>
                        <td id="totalSun">0</td>
                        <td id="totalAll">0</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="validation-panel" id="validationPanel">
            <h3>Validation Issues</h3>
            <ul id="validationList"></ul>
        </div>

        <!-- Weekly Summary by Category -->
        <div class="category-summary" id="categorySummary">
            <h2>Weekly Summary by Category</h2>
            <div class="category-cards">
                <div class="category-card bd-card">
                    <div class="category-title">Business Development</div>
                    <div class="category-hours" id="bdHours">0.0 hrs</div>
                    <div class="category-percent" id="bdPercent">0.0%</div>
                </div>
                <div class="category-card o-card">
                    <div class="category-title">Overheads</div>
                    <div class="category-hours" id="oHours">0.0 hrs</div>
                    <div class="category-percent" id="oPercent">0.0%</div>
                </div>
                <div class="category-card t-card">
                    <div class="category-title">Time Off</div>
                    <div class="category-hours" id="tHours">0.0 hrs</div>
                    <div class="category-percent" id="tPercent">0.0%</div>
                </div>
                <div class="category-card p-card">
                    <div class="category-title">Productive</div>
                    <div class="category-hours" id="pHours">0.0 hrs</div>
                    <div class="category-percent" id="pPercent">0.0%</div>
                </div>
            </div>
        </div>

        <!-- Documentation Sections -->
        <div class="documentation-section">

            <!-- CSV Import Guide -->
            <details class="doc-accordion">
                <summary class="doc-accordion-header">
                    <h2>üìä How to Import CSV into Microsoft Dynamics</h2>
                </summary>
                <div class="doc-accordion-content">
                    <p class="doc-intro">Follow these steps to import your exported timesheet CSV into Microsoft Dynamics (MSD).</p>

                    <!-- Step Cards -->
                    <div class="import-steps">

                        <!-- Step 1 -->
                        <div class="step-card">
                            <div class="step-number">1</div>
                            <div>
                                <h3>Export Your Timesheet CSV</h3>
                                <p>Click the "Export CSV" button at the top of your timesheet to create a CSV file of your weekly hours.</p>
                                <ul>
                                    <li>Ensure all validation errors are resolved before exporting</li>
                                    <li>CSV file will be named: <code>Timesheet_YYYY-MM-DD.csv</code></li>
                                    <li>File will download to your PC's default downloads folder</li>
                                </ul>
                            </div>
                            <div class="step-image">
                                <img src="img/step-1-export.png" alt="Export CSV button location" onclick="openLightbox(this)">
                            </div>
                        </div>

                        <!-- Step 2 -->
                        <div class="step-card">
                            <div class="step-number">2</div>
                            <div>
                                <h3>Open Microsoft Dynamics</h3>
                                <p>Log into your Microsoft Dynamics timesheet entry page</p>
                                <ul>
                                    <li>Navigate to MSD Timesheet, this can be accessed from the KBR Sharepoint</li>
                                </ul>
                            </div>
                            <div class="step-image">
                                <img src="img/step-2-portal.png" alt="KBR Sharepoint with Timesheet Dynamics" onclick="openLightbox(this)">
                            </div>
                        </div>

                        <!-- Step 3 -->
                        <div class="step-card">
                            <div class="step-number">3</div>
                            <div>
                                <h3>Access Import Wizard</h3>
                                <p>Locate and open the CSV import functionality in Microsoft Dynamics.</p>
                                <ul>
                                    <li>Look for "Import from CSV" button</li>
                                    <li>The import wizard should open in a new dialog</li>
                                </ul>
                            </div>
                            <div class="step-image">
                                <img src="img/step-3-import.png" alt="Import from CSV option in Microsoft Dynamics" onclick="openLightbox(this)">
                            </div>
                        </div>

                        <!-- Step 4 -->
                        <div class="step-card">
                            <div class="step-number">4</div>
                            <div>
                                <h3>Select CSV File</h3>
                                <p>Browse for and select your exported timesheet CSV file.</p>
                                <ul>
                                    <li>Click "Browse" or "Choose File" button</li>
                                    <li>Navigate to your downloads folder</li>
                                    <li>Select the <code>Timesheet_YYYY-MM-DD.csv</code> file</li>
                                    <li>Verify the file name appears in the import dialog</li>
                                    <li>Click "Next" followed by "Review Mapping" buttons</li>
                                </ul>
                            </div>
                            <div class="step-image">
                                <img src="img/step-4-upload.png" alt="CSV file upload dialog" onclick="openLightbox(this)">
                            </div>
                        </div>

                        <!-- Step 5 -->
                        <div class="step-card">
                            <div class="step-number">5</div>
                            <div>
                                <h3>Map CSV Columns</h3>
                                <p>Verify that CSV columns are correctly mapped to MSD fields.</p>
                                <ul>
                                    <li>Change "Name Your Data Map" to "Excel Import" using the drop-down menu</li>
                                    <li>Check that Project, Task, Date, and Duration fields are mapped</li>
                                    <li>Ensure Cost Type, CBS, and Role fields align correctly</li>
                                    <li>Most systems auto-detect standard CSV headers</li>
                                    <li>Adjust mappings if necessary</li>
                                    <li>Click "Finish Import" button</li>
                                </ul>
                            </div>
                            <div class="step-image">
                                <img src="img/step-5-mapping.png" alt="CSV column mapping screen" onclick="openLightbox(this)">
                            </div>
                        </div>

                        <!-- Step 6 -->
                        <div class="step-card">
                            <div class="step-number">6</div>
                            <div>
                                <h3>Validate Imported Data</h3>
                                <p>Review the imported timesheet and check for any errors.</p>
                                <ul>
                                    <li>Close the import wizard and refresh the page after a few minutes.</li>
                                    <li>Verify imported timesheet contents match what you expected to be there</li>
                                    <li>Confirm daily and weekly hours totals are correct</li>
                                    <li>Submit timesheet as usual if it is all correct</li>
                                </ul>
                            </div>
                            <div class="step-image">
                                <img src="img/step-6-verify.png" alt="Imported timesheet entries in Microsoft Dynamics" onclick="openLightbox(this)">
                            </div>
                        </div>

                    </div>

                    <!-- Tips Section -->
                    <div class="doc-tip">
                        <strong>üí° Tip:</strong> Save your CSV file with a descriptive name before importing (e.g., "Week_Dec22_YourName.csv") to make it easier to identify if you need to re-import.
                    </div>
                </div>
            </details>

            <!-- Troubleshooting & FAQs -->
            <details class="doc-accordion">
                <summary class="doc-accordion-header">
                    <h2>üîß Troubleshooting & Common Questions</h2>
                </summary>
                <div class="doc-accordion-content">

                    <!-- Search Box -->
                    <div class="faq-search-container">
                        <input type="text" id="faqSearch" class="faq-search-input" placeholder="Search troubleshooting items...">
                    </div>

                    <!-- Quick Links Index -->
                    <div class="faq-index">
                        <h3>Common Issues</h3>
                        <ul>
                            <li><a href="#faq-csv-format">CSV format errors</a></li>
                            <li><a href="#faq-date-format">Invalid date format</a></li>
                            <li><a href="#faq-missing-hours">Hours not showing in MSD</a></li>
                            <li><a href="#faq-validation">Validation errors</a></li>
                            <li><a href="#faq-export-disabled">Export button disabled</a></li>
                            <li><a href="#faq-project-codes">Project codes not recognized</a></li>
                        </ul>
                    </div>

                    <!-- FAQ Category: CSV Export Issues -->
                    <div class="faq-category">
                        <h3>CSV Export Issues</h3>

                        <div class="faq-item" id="faq-csv-format" data-keywords="csv format delimiter comma excel">
                            <div class="faq-question">
                                <span class="faq-badge error">Error</span>
                                Export vailidation errors (Agile Accrual)
                            </div>
                            <div class="faq-answer">
                                <p><strong>Cause:</strong> The day with agile accrual entered does not have enough regular working hours</p>
                                <p><strong>Fix:</strong> In order to enter agile accrual for a given day, there must be enough regular work hours for the day i.e. 40 hours/week need 8 hours/day</p>
                                <p><strong>Prevention:</strong> Ensure that regular worked hours are entered before exporting.</p>
                            </div>
                        </div>

                        <div class="faq-item" id="faq-empty-csv" data-keywords="csv empty no data blank">
                            <div class="faq-question">
                                <span class="faq-badge error">Error</span>
                                Validation Issues (CBS)
                            </div>
                            <div class="faq-answer">
                                <p><strong>Cause:</strong> No CBS was entered for project</p>
                                <p><strong>Fix:</strong> Enter CBS from drop-down menu</p>
                                <p><strong>Prevention:</strong> Enter a CBS for all project work, this does not need to be done for overheads</p>
                            </div>
                        </div>

                        <div class="faq-item" id="faq-special-chars" data-keywords="special characters garbled encoding utf8">
                            <div class="faq-question">
                                <span class="faq-badge warning">Warning</span>
                                Validation Issues (Description)
                            </div>
                            <div class="faq-answer">
                                <p><strong>Cause:</strong> No description was entered for time entry</p>
                                <p><strong>Fix:</strong> Add description to time entry</p>
                                <p><strong>Prevention:</strong> Enter descriptions for each project row</p>
                            </div>
                        </div>

                        <div class="faq-item" id="faq-export-disabled" data-keywords="export button disabled grayed greyed out">
                            <div class="faq-question">
                                <span class="faq-badge error">Error</span>
                                Export button is disabled/grayed out
                            </div>
                            <div class="faq-answer">
                                <p><strong>Cause:</strong> There are validation errors that must be fixed before exporting.</p>
                                <p><strong>Fix:</strong> Check the "Validation Issues" panel (if visible) and resolve all errors marked in red.</p>
                                <p><strong>Prevention:</strong> Regularly check validation status as you enter data. Common issues include missing descriptions for Resource Pool projects.</p>
                            </div>
                        </div>

                    </div>

                    <!-- FAQ Category: MSD Import Issues -->
                    <div class="faq-category">
                        <h3>MSD Import Issues</h3>

                        <div class="faq-item" id="faq-import-wizard" data-keywords="import wizard csv format recognize">
                            <div class="faq-question">
                                <span class="faq-badge error">Error</span>
                                Import wizard doesn't recognize CSV format
                            </div>
                            <div class="faq-answer">
                                <p><strong>Cause:</strong> File extension may be wrong or incorrect wizard was opened, or CSV format doesn't match MSD expectations.</p>
                                <p><strong>Fix:</strong> Ensure file has <code>.csv</code> extension. Try re-exporting from this tool.</p>
                                <p><strong>Prevention:</strong> Confirm that the import CSV function is being used within MSD.</p>
                            </div>
                        </div>

                        <div class="faq-item" id="faq-missing-hours" data-keywords="hours zero blank missing not showing imported">
                            <div class="faq-question">
                                <span class="faq-badge error">Error</span>
                                Project not entering into MSD despite the timesheet entry being correct
                            </div>
                            <div class="faq-answer">
                                <p><strong>Cause:</strong> MSD can cause an error if two identical project tasks exist in different projects</p>
                                <p><strong>Fix:</strong> Instead of using "Project Task" use the "Project Task ID", the mapping should deal with this without any further changes.</p>
                            </div>
                        </div>

                    </div>

                    <!-- FAQ Category: Data Validation Issues -->
                    <div class="faq-category">
                        <h3>Data Validation Issues</h3>

                        <div class="faq-item" id="faq-validation" data-keywords="description required resource pool validation error">
                            <div class="faq-question">
                                <span class="faq-badge error">Error</span>
                                "Description required when Project contains 'RESOURCE POOL'" error
                            </div>
                            <div class="faq-answer">
                                <p><strong>Cause:</strong> Resource pool projects require a description to categorize the activity.</p>
                                <p><strong>Fix:</strong> Add a description (e.g., "Maritime TL - Team meeting", "BD - Client proposal") to any row with "RESOURCE POOL" in the project name.</p>
                                <p><strong>Prevention:</strong> Use Templates feature to save common resource pool descriptions for quick reuse.</p>
                            </div>
                        </div>

                        <div class="faq-item" id="faq-category-wrong" data-keywords="category classification incorrect bd o t p">
                            <div class="faq-question">
                                <span class="faq-badge info">Info</span>
                                Category classification is incorrect
                            </div>
                            <div class="faq-answer">
                                <p><strong>Cause:</strong> Category is auto-determined by project name keywords. Some projects may not match expected patterns.</p>
                                <p><strong>Fix:</strong> Category is for display only and doesn't affect CSV export. The correct data is still exported to MSD.</p>
                            </div>
                        </div>

                    </div>

                    <!-- FAQ Category: General Questions -->
                    <div class="faq-category">
                        <h3>General Questions</h3>

                        <div class="faq-item" id="faq-multiple-weeks" data-keywords="import multiple weeks batch">
                            <div class="faq-question">
                                <span class="faq-badge info">Info</span>
                                How do I import multiple weeks at once?
                            </div>
                            <div class="faq-answer">
                                <p><strong>Answer:</strong> Unfortunately there isn't a way to do this. Export each week separately and import them one at a time into MSD. Each CSV file represents one week.</p>
                                <p>You can use the week navigation buttons to move between weeks and export each one individually.</p>
                            </div>
                        </div>

                        <div class="faq-item" id="faq-edit-after-import" data-keywords="edit data after import modify change">
                            <div class="faq-question">
                                <span class="faq-badge info">Info</span>
                                Can I edit data after importing to MSD?
                            </div>
                            <div class="faq-answer">
                                <p><strong>Answer:</strong> Yes, you can edit hours in Microsoft Dynamics after import. However, changes made in MSD won't sync back to this tool.</p>
                            </div>
                        </div>

                        <div class="faq-item" id="faq-date-format" data-keywords="date format dd/mm/yyyy MM/DD/YYYY">
                            <div class="faq-question">
                                <span class="faq-badge info">Info</span>
                                What date format does MSD expect?
                            </div>
                            <div class="faq-answer">
                                <p><strong>Answer:</strong> This tool exports dates in DD/MM/YYYY format (e.g., 25/12/2025), which is the standard format for most MSD configurations.</p>
                                <p>If your MSD instance uses a different format, contact your system administrator to confirm the required format.</p>
                            </div>
                        </div>

                        <div class="faq-item" id="faq-public-holidays" data-keywords="public holidays time off leave">
                            <div class="faq-question">
                                <span class="faq-badge info">Info</span>
                                How do I handle public holidays in my timesheet?
                            </div>
                            <div class="faq-answer">
                                <p><strong>Answer:</strong> Use the "Public Holiday" template (Templates ‚Üí Public Holiday) which pre-fills the correct project and type.</p>
                                <p>Typically: Project = "Public Holiday (1047)", Type = "Paid Time Off", with 8 hours then add a description for the specific holiday.</p>
                            </div>
                        </div>

                        <div class="faq-item" id="faq-type-difference" data-keywords="work paid time off type difference agile accrual">
                            <div class="faq-question">
                                <span class="faq-badge info">Info</span>
                                What's the difference between "Work", "Paid Time Off", and "Agile Accrual" types?
                            </div>
                            <div class="faq-answer">
                                <p><strong>Work:</strong> Standard project hours, billable or non-billable work activities.</p>
                                <p><strong>Paid Time Off:</strong> Annual leave, sick leave, public holidays - time off that's paid.</p>
                                <p><strong>Agile Accrual:</strong> Flex time or agile hours that accrue for later use (check with your company policy).</p>
                            </div>
                        </div>

                    </div>

                </div>
            </details>


            <!-- Additional Questions & Feedback -->
            <details class="doc-accordion">
                <summary class="doc-accordion-header">
                    <h2>‚úâÔ∏è Additional Questions & Feedback</h2>
                </summary>
                <div class="doc-accordion-content">
                    <p>
                        For bugs, feature requests, or general feedback about the KBR Timesheet Helper,
                        please contact <strong>Chris Leaman</strong> (National Maritime Team Lead) at
                        <a href="mailto:chris.leaman@kbr.com">chris.leaman@kbr.com</a>.
                    </p>
                    <p>
                        We welcome your input to help improve this tool!
                    </p>
                </div>
            </details>

        </div>


    </div>

    <!-- Template Modal -->
    <div class="modal" id="templateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Row Templates</h2>
                <button class="close-btn" onclick="app.closeTemplateModal()">&times;</button>
            </div>
            <div>
                <ul class="template-list" id="templateList"></ul>
                <button class="btn" onclick="app.showSaveTemplate()">+ Save Current Row as Template</button>
            </div>
        </div>
    </div>

    <!-- Save Template Modal -->
    <div class="modal" id="saveTemplateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Save Template</h2>
                <button class="close-btn" onclick="app.closeSaveTemplateModal()">&times;</button>
            </div>
            <div>
                <label for="templateName">Template Name:</label>
                <input type="text" id="templateName" class="modal-input" placeholder="e.g., Maritime TL">
                <label for="templateRow">Select Row to Save:</label>
                <select id="templateRow" class="modal-input"></select>
                <button class="btn" onclick="app.saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>

    <!-- Edit Template Modal -->
    <div class="modal" id="editTemplateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Template</h2>
                <button class="close-btn" onclick="app.closeEditTemplateModal()">&times;</button>
            </div>
            <div>
                <label for="editTemplateName">Template Name:</label>
                <input type="text" id="editTemplateName" class="modal-input" placeholder="Template name">

                <label for="editTemplateProject">Project:</label>
                <input type="text" id="editTemplateProject" class="modal-input" placeholder="Project">

                <label for="editTemplateProjectTask">Project Task:</label>
                <input type="text" id="editTemplateProjectTask" class="modal-input" placeholder="Project Task">

                <label for="editTemplateCbs">CBS:</label>
                <select id="editTemplateCbs" class="modal-input"></select>

                <label for="editTemplateRole">Role:</label>
                <select id="editTemplateRole" class="modal-input"></select>

                <label for="editTemplateType">Type:</label>
                <select id="editTemplateType" class="modal-input"></select>

                <label for="editTemplateDescription">Description:</label>
                <input type="text" id="editTemplateDescription" class="modal-input" placeholder="Description">

                <input type="hidden" id="editTemplateId">

                <div style="margin-top: 15px;">
                    <button class="btn" onclick="app.saveEditedTemplate()">Save Changes</button>
                    <button class="btn btn-secondary" onclick="app.closeEditTemplateModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy from Other Week Modal -->
    <div class="modal" id="copyFromWeekModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Copy Rows from Other Week</h2>
                <button class="close-btn" onclick="app.closeCopyFromWeekModal()">&times;</button>
            </div>
            <div>
                <label for="weekSelector">Select Week:</label>
                <select id="weekSelector" class="modal-input" onchange="app.loadWeekRows()"></select>

                <div id="weekRowsContainer" class="hidden">
                    <div style="margin: 15px 0 0 0; padding: 0;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="includeHours">
                            <span>Include hours when copying</span>
                        </label>
                    </div>
                    <div style="margin: 0 0 15px 0; padding: 0;">
                        <button class="btn btn-secondary" onclick="app.toggleSelectAllWeekRows()">Select All</button>
                    </div>

                    <div class="week-rows-list" id="weekRowsList"></div>

                    <button class="btn" onclick="app.copySelectedRows()">Copy Selected Rows</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Past Row Modal -->
    <div class="modal" id="addPastRowModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Past Row</h2>
                <button class="close-btn" onclick="app.closeAddPastRowModal()">&times;</button>
            </div>
            <div>
                <label for="pastRowSearch">Search past rows:</label>
                <input type="text"
                       id="pastRowSearch"
                       class="modal-input"
                       placeholder="Type to search project, task, or description..."
                       oninput="app.filterPastRows()">

                <div id="pastRowsContainer">
                    <div style="margin: 0 0 15px 0; padding: 0;">
                        <button class="btn btn-secondary" onclick="app.toggleSelectAllPastRows()">Select All</button>
                        <span id="pastRowsCount" style="margin-left: 10px; color: #666;"></span>
                    </div>

                    <div class="week-rows-list" id="pastRowsList"></div>

                    <button class="btn" onclick="app.addSelectedPastRows()">Add Selected Rows</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Expected Hours Modal -->
    <div class="modal" id="expectedHoursModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Expected Hours Settings</h2>
                <button class="close-btn" onclick="app.closeExpectedHoursModal()">&times;</button>
            </div>
            <div>
                <label for="expectedHoursInput">Expected hours per week:</label>
                <input type="number" id="expectedHoursInput" class="modal-input" min="0" step="0.5"
                       placeholder="e.g., 38, 40, 37.5">
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="app.saveExpectedHours()">Save</button>
                    <button class="btn btn-secondary" onclick="app.closeExpectedHoursModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Work Location Modal -->
    <div class="modal" id="workLocationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Work Location Settings</h2>
                <button class="close-btn" onclick="app.closeWorkLocationModal()">&times;</button>
            </div>
            <div>
                <label for="workLocationSelect">Select your work location:</label>
                <select id="workLocationSelect" class="modal-input">
                    <option value="brisbane">Brisbane (03600100000)</option>
                    <option value="sydney">Sydney (SYDNEY_CODE)</option>
                    <option value="melbourne">Melbourne (MELBOURNE_CODE)</option>
                    <option value="perth">Perth (PERTH_CODE)</option>
                    <option value="adelaide">Adelaide (ADELAIDE_CODE)</option>
                </select>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="app.saveWorkLocation()">Save</button>
                    <button class="btn btn-secondary" onclick="app.closeWorkLocationModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Type Modal -->
    <div class="modal" id="costTypeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cost Type Settings</h2>
                <button class="close-btn" onclick="app.closeCostTypeModal()">&times;</button>
            </div>
            <div>
                <p style="margin-bottom: 15px; color: #666;">Select the cost type that matches your MSD timesheet. This value will be used for all timesheet entries.</p>
                <label for="costTypeSelect">Select your cost type:</label>
                <select id="costTypeSelect" class="modal-input">
                    <option value="">-- Select --</option>
                    <option value="structural">Structural (L0700-Structural)</option>
                    <option value="civil">Civil (L0700-Civil)</option>
                </select>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="app.saveCostType()">Save</button>
                    <button class="btn btn-secondary" onclick="app.closeCostTypeModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Warning Modal -->
    <div class="modal" id="exportWarningModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Export</h2>
                <button class="close-btn" onclick="app.closeExportWarningModal()">&times;</button>
            </div>
            <div>
                <p style="margin-bottom: 15px;">
                    You have entered <strong id="modalTotalHours"></strong> hours this week,
                    which is less than your expected <strong id="modalExpectedHours"></strong> hours per week.
                </p>
                <p style="margin-bottom: 20px;">Are you sure you want to export?</p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="app.closeExportWarningModal()">Return to Timesheet</button>
                    <button class="btn" onclick="app.proceedWithExport()">Download CSV Anyway</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Old Weeks Modal -->
    <div class="modal" id="deleteOldWeeksModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Delete Old Weeks</h2>
                <button class="close-btn" onclick="app.closeDeleteOldWeeksModal()">&times;</button>
            </div>
            <div>
                <p style="margin-bottom: 15px;">
                    Delete timesheet data older than:
                </p>
                <div style="margin-bottom: 20px;">
                    <input type="number" id="deleteWeeksThreshold" value="12" min="1" max="52"
                           style="width: 80px; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;"
                           oninput="app.updateDeleteOldWeeksPreview()">
                    <span style="margin-left: 8px;">weeks</span>
                </div>
                <div id="deleteOldWeeksPreview" style="margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
                    <!-- Preview content will be populated by JavaScript -->
                </div>
                <p style="font-size: 12px; color: #666; margin-bottom: 20px;">
                    Note: The current week will not be deleted.
                </p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="app.closeDeleteOldWeeksModal()">Cancel</button>
                    <button class="btn btn-danger" id="confirmDeleteWeeksBtn" onclick="app.confirmDeleteOldWeeks()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Empty Rows Modal -->
    <div class="modal" id="deleteEmptyRowsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Delete Empty Rows</h2>
                <button class="close-btn" onclick="app.closeDeleteEmptyRowsModal()">&times;</button>
            </div>
            <div>
                <p style="margin-bottom: 15px;" id="deleteEmptyRowsMessage">
                    <!-- Message will be populated by JavaScript -->
                </p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="app.closeDeleteEmptyRowsModal()">Cancel</button>
                    <button class="btn btn-danger" id="confirmDeleteEmptyRowsBtn" onclick="app.confirmDeleteEmptyRows()">Delete Empty Rows</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Clear All Hours Modal -->
    <div class="modal" id="clearAllHoursModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Clear All Hours</h2>
                <button class="close-btn" onclick="app.closeClearAllHoursModal()">&times;</button>
            </div>
            <div>
                <p style="margin-bottom: 15px;" id="clearAllHoursMessage">
                    <!-- Message will be populated by JavaScript -->
                </p>
                <p style="margin-bottom: 20px; color: #dc3545; font-weight: 500;">
                    This action cannot be undone.
                </p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="app.closeClearAllHoursModal()">Cancel</button>
                    <button class="btn btn-danger" id="confirmClearAllHoursBtn" onclick="app.confirmClearAllHours()">Clear All Hours</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div class="modal" id="calendarModal" role="dialog" aria-labelledby="calendarModalTitle" aria-modal="true">
        <div class="modal-content calendar-modal-content">
            <div class="modal-header">
                <h2 id="calendarModalTitle">Select Week</h2>
                <button class="close-btn" onclick="app.closeCalendarModal()" aria-label="Close calendar">&times;</button>
            </div>

            <div class="calendar-header">
                <button class="calendar-nav-btn" onclick="app.navigateCalendarMonth(-1)" aria-label="Previous month">
                    &#9664;
                </button>
                <h3 id="calendarMonthYear" aria-live="polite">January 2026</h3>
                <button class="calendar-nav-btn" onclick="app.navigateCalendarMonth(1)" aria-label="Next month">
                    &#9654;
                </button>
            </div>

            <div class="calendar-grid" id="calendarGrid" role="grid" aria-label="Calendar">
                <div class="calendar-weekday-header" role="columnheader">Mon</div>
                <div class="calendar-weekday-header" role="columnheader">Tue</div>
                <div class="calendar-weekday-header" role="columnheader">Wed</div>
                <div class="calendar-weekday-header" role="columnheader">Thu</div>
                <div class="calendar-weekday-header" role="columnheader">Fri</div>
                <div class="calendar-weekday-header" role="columnheader">Sat</div>
                <div class="calendar-weekday-header" role="columnheader">Sun</div>
            </div>

            <div class="calendar-legend">
                <div class="calendar-legend-item">
                    <div class="calendar-legend-color" style="background-color: white; border: 1px solid #ddd;"></div>
                    <span>0 hrs</span>
                </div>
                <div class="calendar-legend-item">
                    <div class="calendar-legend-color" style="background-color: hsl(120, 60%, 75%);"></div>
                    <span>1-7 hrs</span>
                </div>
                <div class="calendar-legend-item">
                    <div class="calendar-legend-color" style="background-color: hsl(120, 60%, 40%);"></div>
                    <span>8+ hrs</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Lightbox for Documentation Images -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img id="lightbox-img" src="" alt="Enlarged screenshot">
        <div class="lightbox-hint">Click anywhere or press Esc to close</div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            dropdownOptions: {
                role: ["Team Member", "Project Manager"],
                type: ["Work", "Paid Time Off", "Agile Accrual"],
                cbs: [
                    "A030700-Design Documents & Drawings",
                    "A020200-Project Management",
                    "A030502-Conceptual, Scoping & Special Studies",
                    "A030800-Modeling & Design Databases",
                    "A200500-Environmental Management",
                    "A000000-Home Office & Consulting Services"
                ]
            },

            costTypes: {
                structural: { name: "Structural", code: "L0700-Structural" },
                civil: { name: "Civil", code: "L0700-Civil" }
            },

            workLocations: {
                brisbane: { name: "Brisbane", code: "036001000000", statePrefix: "QLD" },
                sydney: { name: "Sydney", code: "SYDNEY_CODE", statePrefix: "NSW" },
                melbourne: { name: "Melbourne", code: "MELBOURNE_CODE", statePrefix: "VIC" },
                perth: { name: "Perth", code: "PERTH_CODE", statePrefix: "WA" },
                adelaide: { name: "Adelaide", code: "ADELAIDE_CODE", statePrefix: "SA" }
            },

            csvDefaults: {
                timeSource: "Project Service",
                entryStatus: "Draft"
            },

            validationRules: [
                {
                    id: "resourcePoolDescription",
                    level: "error",
                    message: "Description required when Project contains 'RESOURCE POOL'",
                    test: (row) => {
                        if (row.project?.toUpperCase().includes("RESOURCE POOL")) {
                            return row.description?.trim().length > 0;
                        }
                        return true;
                    }
                },
                {
                    id: "agileAccrualRequires8Hours",
                    level: "warning",
                    message: "", // Generated dynamically per day
                    test: function(row, weekData) {
                        // Skip if not Agile Accrual type
                        if (row.type !== "Agile Accrual") {
                            return true;
                        }

                        // If weekData not provided (old validation calls), pass validation
                        if (!weekData || !weekData.rows) {
                            return true;
                        }

                        const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                        const dayNames = {
                            mon: 'Monday',
                            tue: 'Tuesday',
                            wed: 'Wednesday',
                            thu: 'Thursday',
                            fri: 'Friday',
                            sat: 'Saturday',
                            sun: 'Sunday'
                        };

                        // Check each day that has Agile Accrual hours
                        for (const day of days) {
                            const agileHours = row.hours[day] || 0;

                            if (agileHours > 0) {
                                // Calculate total Work hours for this day across all rows
                                const workHours = weekData.rows
                                    .filter(r => r.type === "Work")
                                    .reduce((sum, r) => sum + (r.hours[day] || 0), 0);

                                if (workHours < 8) {
                                    // Return rich result object instead of mutating state
                                    return {
                                        pass: false,
                                        violationDay: dayNames[day],
                                        violationWorkHours: workHours
                                    };
                                }
                            }
                        }

                        return true;
                    }
                }
            ],

            shortcuts: {
                addRow: "Ctrl+Enter",
                deleteRow: "Ctrl+Delete",
                duplicateRow: "Ctrl+D"
            },

            predefinedTemplates: [
                {
                    id: "predefined-office-overheads",
                    name: "Office Overheads",
                    predefined: true,
                    locationDynamic: true,
                    fields: {
                        project: "{STATE} RESOURCE POOL",
                        projectTask: "00001.0001 General",
                        cbs: "A030700-Design Documents & Drawings",
                        role: "Team Member",
                        type: "Work",
                        description: "{STATE} Overheads"
                    }
                },
                {
                    id: "predefined-unapplied-defence-bids",
                    name: "Unapplied Defence Bids",
                    predefined: true,
                    locationDynamic: true,
                    fields: {
                        project: "{STATE} RESOURCE POOL",
                        projectTask: "10001.00102 Unapplied Bid Hours - Defence Infrastructure & Buildings", // check spacing
                        cbs: "A030700-Design Documents & Drawings",
                        role: "Team Member",
                        type: "Work",
                        description: "Unapplied Defence Bids"
                    }
                },
                {
                    id: "predefined-unapplied-transport-bids",
                    name: "Unapplied Transport Bids",
                    predefined: true,
                    locationDynamic: true,
                    fields: {
                        project: "{STATE} RESOURCE POOL",
                        projectTask: "10001.00102 Unapplied Bid Hours - Transport",
                        cbs: "A030700-Design Documents & Drawings",
                        role: "Team Member",
                        type: "Work",
                        description: "Unapplied Transport Bids"
                    }
                },
                {
                    id: "predefined-annual-leave",
                    name: "Annual Leave",
                    predefined: true,
                    fields: {
                        project: "Paid Time Off (1047)",
                        projectTask: "Annual Leave (1047)",
                        cbs: "",
                        role: "Team Member",
                        type: "Paid Time Off",
                        description: "Annual Leave"
                    }
                },
                {
                    id: "predefined-public-holiday",
                    name: "Public Holiday",
                    predefined: true,
                    fields: {
                        project: "Public Holiday (1047)",
                        projectTask: "Public Holiday (1047)",
                        cbs: "",
                        role: "Team Member",
                        type: "Paid Time Off",
                        description: "Public Holiday"
                    }
                },
                {
                    id: "predefined-flex-time-off",
                    name: "Flex Time Off",
                    predefined: true,
                    fields: {
                        project: "Paid Time Off",
                        projectTask: "Agile Time Off (1047)",
                        cbs: "",
                        role: "Team Member",
                        type: "Paid Time Off",
                        description: "Flex Time Off"
                    }
                },
                {
                    id: "predefined-unpaid-leave",
                    name: "Unpaid Leave",
                    predefined: true,
                    fields: {
                        project: "Unpaid Leave",
                        projectTask: "Unpaid Leave (1047)",
                        cbs: "",
                        role: "Team Member",
                        type: "Paid Time Off", // todo - check if this is correct
                        description: "Unpaid Leave"
                    }
                },
            ]
        };

        // ==================== COLUMN SORTING CONFIGURATION ====================
        const COLUMN_CONFIG = {
            // Text fields
            project: {
                sortable: true,
                type: 'text',
                accessor: (row) => row.project || ''
            },
            projectTask: {
                sortable: true,
                type: 'text',
                accessor: (row) => row.projectTask || ''
            },
            description: {
                sortable: true,
                type: 'text',
                accessor: (row) => row.description || ''
            },

            // Dropdown fields
            cbs: {
                sortable: true,
                type: 'text',
                accessor: (row) => row.cbs || ''
            },
            role: {
                sortable: true,
                type: 'text',
                accessor: (row) => row.role || ''
            },
            type: {
                sortable: true,
                type: 'text',
                accessor: (row) => row.type || ''
            },

            // Calculated text field
            category: {
                sortable: true,
                type: 'text',
                accessor: function(row) {
                    return this.getCategory(row.project) || '';
                }
            },

            // Hour columns (numeric)
            mon: { sortable: true, type: 'number', accessor: (row) => parseFloat(row.hours.mon) || 0 },
            tue: { sortable: true, type: 'number', accessor: (row) => parseFloat(row.hours.tue) || 0 },
            wed: { sortable: true, type: 'number', accessor: (row) => parseFloat(row.hours.wed) || 0 },
            thu: { sortable: true, type: 'number', accessor: (row) => parseFloat(row.hours.thu) || 0 },
            fri: { sortable: true, type: 'number', accessor: (row) => parseFloat(row.hours.fri) || 0 },
            sat: { sortable: true, type: 'number', accessor: (row) => parseFloat(row.hours.sat) || 0 },
            sun: { sortable: true, type: 'number', accessor: (row) => parseFloat(row.hours.sun) || 0 },

            // Calculated numeric field
            total: {
                sortable: true,
                type: 'number',
                accessor: function(row) {
                    return parseFloat(this.getRowTotal(row)) || 0;
                }
            },

            // Non-sortable
            action: { sortable: false }
        };

        // ==================== DATA MODEL & STATE ====================
        const app = {
            data: {
                version: 1,
                preferences: {
                    lastWeekStart: null,
                    timeIncrement: 0.5,
                    expectedWeeklyHours: 38,
                    workLocation: 'brisbane'
                },
                dropdownOptions: CONFIG.dropdownOptions,
                templates: [],
                weeks: {}
            },
            currentWeekStart: null,
            selectedCell: null,
            saveTimeout: null,
            hideEmptyRows: false,

            // ==================== INITIALIZATION ====================
            init() {
                this.loadData();

                // Set default expected hours if not set
                if (this.data.preferences.expectedWeeklyHours === undefined) {
                    this.data.preferences.expectedWeeklyHours = 38;
                }

                // Set default work location if not set
                if (!this.data.preferences.workLocation) {
                    this.data.preferences.workLocation = 'brisbane';
                }

                this.currentWeekStart = this.data.preferences.lastWeekStart || this.getCurrentWeekStart();
                this.ensureWeekExists(this.currentWeekStart);
                this.render();
                this.setupEventListeners();

                // Initialize expected hours display
                document.getElementById('expectedHoursValue').textContent =
                    this.data.preferences.expectedWeeklyHours;

                // Initialize work location display
                this.updateWorkLocationDisplay();

                // Initialize cost type display
                this.updateCostTypeDisplay();
            },

            getCurrentWeekStart() {
                const today = new Date();
                const day = today.getDay();
                const diff = (day === 0 ? -6 : 1) - day; // Adjust when day is Sunday
                const monday = new Date(today);
                monday.setDate(today.getDate() + diff);
                return this.formatDate(monday);
            },

            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            parseDate(dateStr) {
                const [year, month, day] = dateStr.split('-').map(Number);
                return new Date(year, month - 1, day);
            },

            formatDisplayDate(dateStr) {
                const date = this.parseDate(dateStr);
                const options = { month: 'short', day: 'numeric', year: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            },

            // ==================== CATEGORY CLASSIFICATION ====================
            getCategory(projectName) {
                if (!projectName) return 'P'; // Default to Productive if empty

                const project = projectName.trim();

                // Business Development: ends with "BP"
                if (/BP$/i.test(project)) return 'BD';

                // Overheads: contains "RESOURCE POOL"
                if (/RESOURCE\s+POOL/i.test(project)) return 'O';

                // Time Off: contains "TIME OFF"
                if (/TIME\s+OFF/i.test(project)) return 'T';

                // Productive: everything else
                return 'P';
            },

            getCategoryAbbrev(category) {
                return category; // Already abbreviated
            },

            getCategoryFull(category) {
                const names = {
                    'BD': 'Business Development',
                    'O': 'Overheads',
                    'T': 'Time Off',
                    'P': 'Productive'
                };
                return names[category] || 'Productive';
            },

            getWeekDates(weekStart) {
                const start = this.parseDate(weekStart);
                const dates = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(start);
                    date.setDate(start.getDate() + i);
                    dates.push(date);
                }
                return dates;
            },

            ensureWeekExists(weekStart) {
                if (!this.data.weeks[weekStart]) {
                    const newRow = this.createEmptyRow();
                    this.data.weeks[weekStart] = {
                        weekStart: weekStart,
                        rows: [newRow],
                        sortState: {
                            column: null,
                            direction: null,
                            originalOrder: [newRow.id]
                        }
                    };
                }

                // Migration: Ensure sortState exists for legacy data
                if (!this.data.weeks[weekStart].sortState) {
                    this.data.weeks[weekStart].sortState = {
                        column: null,
                        direction: null,
                        originalOrder: this.data.weeks[weekStart].rows.map(r => r.id)
                    };
                }

                // Migration: Ensure originalOrder exists and is valid
                const sortState = this.data.weeks[weekStart].sortState;
                if (!sortState.originalOrder || !Array.isArray(sortState.originalOrder) || sortState.originalOrder.length === 0) {
                    sortState.originalOrder = this.data.weeks[weekStart].rows.map(r => r.id);
                }
            },

            createEmptyRow() {
                return {
                    id: 'row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    project: '',
                    projectTask: '',
                    cbs: '',
                    role: '',
                    type: '',
                    description: '',
                    hours: {
                        mon: 0,
                        tue: 0,
                        wed: 0,
                        thu: 0,
                        fri: 0,
                        sat: 0,
                        sun: 0
                    }
                };
            },

            // ==================== DATA PERSISTENCE ====================
            loadData() {
                try {
                    const stored = localStorage.getItem('kbrTimesheet');
                    if (stored) {
                        this.data = JSON.parse(stored);
                    }
                    // Always sync dropdownOptions from CONFIG to ensure new values are available
                    this.data.dropdownOptions = CONFIG.dropdownOptions;

                    // Migration: Remove per-row workLocation and costType (now global settings)
                    if (this.data.weeks) {
                        Object.values(this.data.weeks).forEach(week => {
                            if (week.rows) {
                                week.rows.forEach(row => {
                                    delete row.workLocation;
                                    delete row.costType;
                                });
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    alert('Error loading saved data. Starting fresh.');
                }
            },

            saveData() {
                try {
                    localStorage.setItem('kbrTimesheet', JSON.stringify(this.data));
                    this.updateSaveIndicator('saved');
                } catch (error) {
                    console.error('Error saving data:', error);
                    this.updateSaveIndicator('error');
                    alert('Error saving data. localStorage may be full. Please export your data as backup.');
                }
            },

            debouncedSave() {
                this.updateSaveIndicator('saving');
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => this.saveData(), 500);
            },

            updateSaveIndicator(status) {
                const indicator = document.getElementById('saveIndicator');
                if (!indicator) return;
                indicator.classList.remove('saving', 'error');
                if (status === 'saving') {
                    indicator.textContent = 'Saving...';
                    indicator.classList.add('saving');
                } else if (status === 'error') {
                    indicator.textContent = 'Save failed';
                    indicator.classList.add('error');
                } else {
                    indicator.textContent = 'Saved';
                }
            },

            // ==================== UI RENDERING ====================
            render() {
                this.renderWeekDisplay();
                this.applySortIfNeeded();       // Apply sort before rendering table
                this.renderTable();
                this.updateSortIndicators();    // Update visual indicators
                this.updateClearSortButton();   // Show/hide Clear Sort button
                this.updateHideEmptyRowsButton(); // Update Hide Empty Rows button state
                this.updateTotals();
                this.validateAndDisplay();
            },

            renderWeekDisplay() {
                const weekDates = this.getWeekDates(this.currentWeekStart);
                const startStr = this.formatDisplayDate(this.currentWeekStart);
                const endDate = weekDates[6];
                const endStr = this.formatDisplayDate(this.formatDate(endDate));
                document.getElementById('weekDisplay').textContent = `Week of ${startStr} - ${endStr}`;
            },

            renderTable() {
                const tbody = document.getElementById('timesheetBody');
                tbody.innerHTML = '';

                const currentWeek = this.data.weeks[this.currentWeekStart];
                if (!currentWeek || !currentWeek.rows) return;

                // Filter rows if hideEmptyRows is enabled
                const rowsToRender = this.hideEmptyRows
                    ? currentWeek.rows.filter(row => this.rowHasHours(row))
                    : currentWeek.rows;

                rowsToRender.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.dataset.rowId = row.id;
                    tr.dataset.rowIndex = index;

                    // Add category class for color coding
                    const category = this.getCategory(row.project);
                    tr.className = `category-${category.toLowerCase()}`;

                    tr.innerHTML = `
                        <td class="action-cell">
                            ${this.currentWeekStart !== this.getCurrentWeekStart()
                                ? `<button class="copy-to-current-btn"
                                           onclick="app.copyRowToCurrentWeek('${row.id}')"
                                           title="Copy to Current Week">‚ûú</button>`
                                : ''}
                            <button class="duplicate-btn" onclick="app.duplicateRow('${row.id}')" title="Duplicate row">‚ßâ</button>
                            <button class="delete-btn" onclick="app.deleteRow('${row.id}')" title="Delete row">‚úñ</button>
                        </td>
                        <td><input type="text" value="${row.project}" data-field="project" data-row="${row.id}"></td>
                        <td><input type="text" value="${row.projectTask}" data-field="projectTask" data-row="${row.id}"></td>
                        <td>${this.renderSelect('cbs', row.cbs, row.id)}</td>
                        <td>${this.renderSelect('role', row.role, row.id)}</td>
                        <td>${this.renderSelect('type', row.type, row.id)}</td>
                        <td><input type="text" value="${row.description}" data-field="description" data-row="${row.id}"></td>
                        <td class="category-cell" data-row="${row.id}" title="${this.getCategoryFull(this.getCategory(row.project))}">${this.getCategory(row.project)}</td>
                        <td><input type="number" class="hours-input${(parseFloat(row.hours.mon) || 0) === 0 ? ' zero-value' : ''}" step="0.5" min="0" value="${row.hours.mon}" data-field="hours.mon" data-row="${row.id}"></td>
                        <td><input type="number" class="hours-input${(parseFloat(row.hours.tue) || 0) === 0 ? ' zero-value' : ''}" step="0.5" min="0" value="${row.hours.tue}" data-field="hours.tue" data-row="${row.id}"></td>
                        <td><input type="number" class="hours-input${(parseFloat(row.hours.wed) || 0) === 0 ? ' zero-value' : ''}" step="0.5" min="0" value="${row.hours.wed}" data-field="hours.wed" data-row="${row.id}"></td>
                        <td><input type="number" class="hours-input${(parseFloat(row.hours.thu) || 0) === 0 ? ' zero-value' : ''}" step="0.5" min="0" value="${row.hours.thu}" data-field="hours.thu" data-row="${row.id}"></td>
                        <td><input type="number" class="hours-input${(parseFloat(row.hours.fri) || 0) === 0 ? ' zero-value' : ''}" step="0.5" min="0" value="${row.hours.fri}" data-field="hours.fri" data-row="${row.id}"></td>
                        <td><input type="number" class="hours-input${(parseFloat(row.hours.sat) || 0) === 0 ? ' zero-value' : ''}" step="0.5" min="0" value="${row.hours.sat}" data-field="hours.sat" data-row="${row.id}"></td>
                        <td><input type="number" class="hours-input${(parseFloat(row.hours.sun) || 0) === 0 ? ' zero-value' : ''}" step="0.5" min="0" value="${row.hours.sun}" data-field="hours.sun" data-row="${row.id}"></td>
                        <td class="row-total${(parseFloat(this.getRowTotal(row)) || 0) === 0 ? ' zero-value' : ''}">${this.getRowTotal(row)}</td>
                    `;

                    tbody.appendChild(tr);
                });
            },

            renderSelect(field, value, rowId) {
                const options = this.data.dropdownOptions[field] || [];
                let html = `<select data-field="${field}" data-row="${rowId}">`;
                html += '<option value=""></option>';
                options.forEach(opt => {
                    html += `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`;
                });
                html += '</select>';
                return html;
            },

            getRowTotal(row) {
                return Object.values(row.hours).reduce((sum, h) => sum + parseFloat(h || 0), 0).toFixed(1);
            },

            hasWeekData(weekStart) {
                const week = this.data?.weeks?.[weekStart];
                const rows = week?.rows;
                if (!Array.isArray(rows) || rows.length === 0) return false;

                // Short-circuit check: return true if ANY row has ANY hour cell > 0
                return rows.some(row => {
                    const hoursObj = row?.hours;
                    if (!hoursObj || typeof hoursObj !== "object") return false;

                    // Check if any hour value is > 0
                    return Object.values(hoursObj).some(h => {
                        const n = Number(h);
                        return Number.isFinite(n) && n > 0;
                    });
                });
            },

            updateTotals() {
                const currentWeek = this.data.weeks[this.currentWeekStart];
                if (!currentWeek) return;

                const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                const totals = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 };

                currentWeek.rows.forEach(row => {
                    days.forEach(day => {
                        totals[day] += parseFloat(row.hours[day] || 0);
                    });
                });

                days.forEach(day => {
                    const capitalDay = day.charAt(0).toUpperCase() + day.slice(1);
                    document.getElementById('total' + capitalDay).textContent = totals[day].toFixed(1);
                });

                const grandTotal = Object.values(totals).reduce((sum, t) => sum + t, 0);
                document.getElementById('totalAll').textContent = grandTotal.toFixed(1);

                // Update category summary
                this.updateCategorySummary();
            },

            updateCategoryCellForRow(rowId, projectValue, inputEl) {
                const category = this.getCategory(projectValue);
                const full = this.getCategoryFull(category);

                // Prefer DOM locality: safest + fastest (works even if there are duplicate IDs elsewhere)
                const tr = inputEl?.closest?.('tr') || document.querySelector(`tr[data-row-id="${rowId}"]`);
                if (!tr) return;

                const td = tr.querySelector('.category-cell');
                if (!td) return;

                // Avoid touching the input; only patch the dependent cell
                td.textContent = category;
                td.title = full;

                // Update row color class based on category
                tr.className = `category-${category.toLowerCase()}`;
            },

            // ==================== CATEGORY SUMMARY ====================
            calculateCategorySummary() {
                const week = this.data.weeks[this.currentWeekStart];
                if (!week) return { BD: 0, O: 0, T: 0, P: 0 };

                const summary = { BD: 0, O: 0, T: 0, P: 0 };
                const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

                week.rows.forEach(row => {
                    const category = this.getCategory(row.project);
                    const rowTotal = days.reduce((sum, day) => sum + (row.hours[day] || 0), 0);
                    summary[category] += rowTotal;
                });

                return summary;
            },

            updateCategorySummary() {
                const summary = this.calculateCategorySummary();
                const expectedHours = this.data.preferences.expectedWeeklyHours || 38;

                // Update Business Development
                document.getElementById('bdHours').textContent = `${summary.BD.toFixed(1)} hrs`;
                document.getElementById('bdPercent').textContent =
                    `${((summary.BD / expectedHours) * 100).toFixed(1)}%`;

                // Update Overheads
                document.getElementById('oHours').textContent = `${summary.O.toFixed(1)} hrs`;
                document.getElementById('oPercent').textContent =
                    `${((summary.O / expectedHours) * 100).toFixed(1)}%`;

                // Update Time Off
                document.getElementById('tHours').textContent = `${summary.T.toFixed(1)} hrs`;
                document.getElementById('tPercent').textContent =
                    `${((summary.T / expectedHours) * 100).toFixed(1)}%`;

                // Update Productive
                document.getElementById('pHours').textContent = `${summary.P.toFixed(1)} hrs`;
                document.getElementById('pPercent').textContent =
                    `${((summary.P / expectedHours) * 100).toFixed(1)}%`;
            },

            // ==================== EVENT HANDLERS ====================
            setupEventListeners() {
                // Input change events
                document.getElementById('timesheetBody').addEventListener('input', (e) => {
                    if (e.target.matches('input, select')) {
                        this.handleInputChange(e.target);
                    }
                });

                // Keyboard navigation
                document.getElementById('timesheetBody').addEventListener('keydown', (e) => {
                    this.handleKeyNavigation(e);
                });

                // Copy/paste
                document.getElementById('timesheetBody').addEventListener('paste', (e) => {
                    this.handlePaste(e);
                });

                // Mouse wheel for hours adjustment
                document.getElementById('timesheetBody').addEventListener('wheel', (e) => {
                    this.handleWheel(e);
                }, { passive: false });

                // Global keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    this.handleGlobalShortcuts(e);
                });
            },

            handleInputChange(input) {
                const rowId = input.dataset.row;
                const field = input.dataset.field;
                const value = input.value;

                const currentWeek = this.data.weeks[this.currentWeekStart];
                const row = currentWeek.rows.find(r => r.id === rowId);

                if (row) {
                    if (field.startsWith('hours.')) {
                        const day = field.split('.')[1];
                        row.hours[day] = parseFloat(value) || 0;

                        // Update zero-value class on the input
                        const numValue = parseFloat(value) || 0;
                        if (numValue === 0) {
                            input.classList.add('zero-value');
                        } else {
                            input.classList.remove('zero-value');
                        }

                        // Update row total's zero-value class and text content
                        const tr = input.closest('tr');
                        const totalCell = tr.querySelector('.row-total');
                        if (totalCell) {
                            const rowTotal = parseFloat(this.getRowTotal(row)) || 0;
                            totalCell.textContent = this.getRowTotal(row);
                            if (rowTotal === 0) {
                                totalCell.classList.add('zero-value');
                            } else {
                                totalCell.classList.remove('zero-value');
                            }
                        }
                    } else {
                        row[field] = value;
                    }

                    // Update category cell if project field changes (without losing focus)
                    if (field === 'project') {
                        this.updateCategoryCellForRow(rowId, value, input);
                    }

                    this.updateTotals();
                    this.validateAndDisplay();
                    this.debouncedSave();
                }
            },

            handleKeyNavigation(e) {
                const input = e.target;
                if (!input.matches('input, select')) return;

                let handled = false;

                // Arrow key navigation
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    const td = input.closest('td');
                    const tr = td.closest('tr');
                    const cellIndex = Array.from(tr.cells).indexOf(td);

                    let newTr = tr;
                    let newCellIndex = cellIndex;

                    const isHoursInput = input.classList.contains('hours-input');

                    if (e.key === 'ArrowUp') {
                        newTr = tr.previousElementSibling;
                    } else if (e.key === 'ArrowDown') {
                        newTr = tr.nextElementSibling;
                    } else if (e.key === 'ArrowLeft' && (isHoursInput || (input.tagName === 'INPUT' && input.selectionStart === 0))) {
                        newCellIndex = cellIndex - 1;
                    } else if (e.key === 'ArrowRight' && (isHoursInput || (input.tagName === 'INPUT' && input.selectionStart === input.value.length))) {
                        newCellIndex = cellIndex + 1;
                    }

                    if (newTr && newTr !== tr && newTr.cells[cellIndex]) {
                        const newInput = newTr.cells[cellIndex].querySelector('input, select');
                        if (newInput) {
                            newInput.focus();
                            handled = true;
                        }
                    } else if (newCellIndex !== cellIndex && tr.cells[newCellIndex]) {
                        const newInput = tr.cells[newCellIndex].querySelector('input, select');
                        if (newInput) {
                            newInput.focus();
                            handled = true;
                        }
                    }
                }

                if (handled) {
                    e.preventDefault();
                }
            },

            handleGlobalShortcuts(e) {
                // Ctrl+Enter: Add row
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    this.addRow();
                }
                // Ctrl+Delete: Delete current row
                else if (e.ctrlKey && e.key === 'Delete') {
                    e.preventDefault();
                    const input = document.activeElement;
                    if (input.matches('input, select')) {
                        const rowId = input.dataset.row;
                        if (rowId) this.deleteRow(rowId);
                    }
                }
                // Ctrl+D: Duplicate current row
                else if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    const input = document.activeElement;
                    if (input.matches('input, select')) {
                        const rowId = input.dataset.row;
                        if (rowId) this.duplicateRow(rowId);
                    }
                }
            },

            handleWheel(e) {
                const input = e.target;

                // Only handle hours inputs that are focused
                if (!input.classList.contains('hours-input')) return;
                if (document.activeElement !== input) return;

                e.preventDefault();

                const increment = this.data.preferences.timeIncrement || 0.5;
                const currentValue = parseFloat(input.value) || 0;
                const delta = e.deltaY < 0 ? increment : -increment;
                const newValue = Math.min(12, Math.max(0, currentValue + delta));

                input.value = newValue;
                this.handleInputChange(input);
            },

            handlePaste(e) {
                const input = e.target;
                if (!input.matches('input')) return;

                const clipboardData = e.clipboardData.getData('text');
                if (!clipboardData.includes('\t') && !clipboardData.includes('\n')) return;

                e.preventDefault();

                const rows = clipboardData.split('\n').map(row => row.split('\t'));
                const td = input.closest('td');
                const tr = td.closest('tr');
                const startCellIndex = Array.from(tr.cells).indexOf(td);
                const startRowIndex = parseInt(tr.dataset.rowIndex);

                const currentWeek = this.data.weeks[this.currentWeekStart];

                rows.forEach((rowData, rowOffset) => {
                    const targetRowIndex = startRowIndex + rowOffset;
                    // Only create new rows if not hiding empty rows
                    if (targetRowIndex >= currentWeek.rows.length && !this.hideEmptyRows) {
                        this.addRow();
                    }

                    rowData.forEach((cellValue, cellOffset) => {
                        const targetCellIndex = startCellIndex + cellOffset;
                        const targetTr = document.querySelectorAll('#timesheetBody tr')[targetRowIndex];
                        if (targetTr && targetTr.cells[targetCellIndex]) {
                            const targetInput = targetTr.cells[targetCellIndex].querySelector('input, select');
                            if (targetInput) {
                                targetInput.value = cellValue.trim();
                                this.handleInputChange(targetInput);
                            }
                        }
                    });
                });

                this.render();
            },

            // ==================== ROW OPERATIONS ====================
            addRow() {
                const currentWeek = this.data.weeks[this.currentWeekStart];
                const newRow = this.createEmptyRow();
                currentWeek.rows.push(newRow);

                // Track in original order
                currentWeek.sortState.originalOrder.push(newRow.id);

                this.render();
                this.saveData();
            },

            deleteRow(rowId) {
                const currentWeek = this.data.weeks[this.currentWeekStart];
                currentWeek.rows = currentWeek.rows.filter(r => r.id !== rowId);

                // Remove from original order
                currentWeek.sortState.originalOrder =
                    currentWeek.sortState.originalOrder.filter(id => id !== rowId);

                if (currentWeek.rows.length === 0) {
                    const newRow = this.createEmptyRow();
                    currentWeek.rows.push(newRow);
                    // Reset original order for new empty row
                    currentWeek.sortState.originalOrder = [newRow.id];
                }
                this.render();
                this.saveData();
            },

            duplicateRow(rowId) {
                const currentWeek = this.data.weeks[this.currentWeekStart];
                const row = currentWeek.rows.find(r => r.id === rowId);
                if (row) {
                    const newRow = JSON.parse(JSON.stringify(row));
                    newRow.id = 'row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    newRow.hours = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 };
                    const index = currentWeek.rows.findIndex(r => r.id === rowId);
                    currentWeek.rows.splice(index + 1, 0, newRow);

                    // Insert into original order right after source
                    const origIndex = currentWeek.sortState.originalOrder.indexOf(rowId);
                    if (origIndex !== -1) {
                        currentWeek.sortState.originalOrder.splice(origIndex + 1, 0, newRow.id);
                    } else {
                        // Fallback: append to end if source not found
                        currentWeek.sortState.originalOrder.push(newRow.id);
                    }

                    this.render();
                    this.saveData();
                }
            },

            copyRowToCurrentWeek(rowId) {
                // Get real-world current week
                const realCurrentWeekStart = this.getCurrentWeekStart();

                // Find the source row
                const sourceWeek = this.data.weeks[this.currentWeekStart];
                const sourceRow = sourceWeek.rows.find(r => r.id === rowId);

                if (!sourceRow) return;

                // Ensure target week exists (auto-create if needed)
                this.ensureWeekExists(realCurrentWeekStart);
                const targetWeek = this.data.weeks[realCurrentWeekStart];

                // Deep clone the row (use structuredClone if available, fallback to JSON)
                const newRow = typeof structuredClone === 'function'
                    ? structuredClone(sourceRow)
                    : JSON.parse(JSON.stringify(sourceRow));

                // Generate new unique ID
                newRow.id = 'row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                // Clear hours (don't copy hours)
                newRow.hours = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 };

                // Append to target week
                targetWeek.rows.push(newRow);

                // Track in original order
                targetWeek.sortState.originalOrder.push(newRow.id);

                // Save data (don't re-render since we're not viewing target week)
                this.saveData();

                // Show success notification with optional navigation
                this.showCopySuccessToast(realCurrentWeekStart);
            },

            showCopySuccessToast(targetWeekStart) {
                // Format the target week dates for display
                const targetWeekDates = this.getWeekDates(targetWeekStart);
                const targetStart = this.formatDisplayDate(targetWeekStart);
                const targetEnd = this.formatDisplayDate(this.formatDate(targetWeekDates[6]));

                // Create toast element
                const toast = document.createElement('div');
                toast.className = 'copy-toast';
                toast.innerHTML = `
                    <span>Row copied to current week (${targetStart} - ${targetEnd})</span>
                    <button class="toast-view-btn" onclick="app.navigateToCurrentWeek(); app.dismissToast()">View</button>
                    <button class="toast-dismiss-btn" onclick="app.dismissToast()">&times;</button>
                `;

                // Add to page
                document.body.appendChild(toast);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (toast.parentElement) {
                        this.dismissToast();
                    }
                }, 5000);
            },

            dismissToast() {
                const toast = document.querySelector('.copy-toast');
                if (toast) {
                    toast.classList.add('fade-out');
                    setTimeout(() => toast.remove(), 300);
                }
            },

            navigateToCurrentWeek() {
                const currentWeekStart = this.getCurrentWeekStart();
                this.currentWeekStart = currentWeekStart;
                this.ensureWeekExists(this.currentWeekStart);
                this.data.preferences.lastWeekStart = this.currentWeekStart;
                this.render();
                this.saveData();
            },

            // ==================== COLUMN SORTING ====================
            sortColumn(columnName) {
                const week = this.data.weeks[this.currentWeekStart];
                if (!week || !week.sortState) return;

                const config = COLUMN_CONFIG[columnName];
                if (!config || !config.sortable) return;

                const { sortState } = week;

                // Two-state cycle logic
                if (sortState.column !== columnName) {
                    // New column: start with ascending
                    sortState.column = columnName;
                    sortState.direction = 'asc';
                } else if (sortState.direction === 'asc') {
                    // Same column, was ascending: go descending
                    sortState.direction = 'desc';
                } else {
                    // Same column, was descending: toggle back to ascending
                    sortState.direction = 'asc';
                }

                // Apply sort
                this.applySortToRows(columnName, sortState.direction, config);

                // Re-render table and update indicators
                this.render();
                this.debouncedSave();
            },

            applySortToRows(columnName, direction, config) {
                const week = this.data.weeks[this.currentWeekStart];
                const { accessor, type } = config;

                week.rows.sort((a, b) => {
                    // Extract values using accessor (bind this for calculated fields)
                    const valA = accessor.call(this, a);
                    const valB = accessor.call(this, b);

                    // Handle empty/null values: always sort to end
                    const isEmptyA = valA === null || valA === undefined || valA === '';
                    const isEmptyB = valB === null || valB === undefined || valB === '';

                    if (isEmptyA && isEmptyB) return 0;
                    if (isEmptyA) return 1;   // A to end
                    if (isEmptyB) return -1;  // B to end

                    // Perform type-specific comparison
                    let comparison;
                    if (type === 'number') {
                        const numA = parseFloat(valA);
                        const numB = parseFloat(valB);
                        comparison = numA - numB;
                    } else {
                        // Text comparison: case-insensitive, locale-aware
                        comparison = String(valA).toLowerCase().localeCompare(
                            String(valB).toLowerCase()
                        );
                    }

                    // Apply direction
                    return direction === 'asc' ? comparison : -comparison;
                });
            },

            clearSort() {
                const week = this.data.weeks[this.currentWeekStart];
                if (!week || !week.sortState) return;

                // Clear sort state
                week.sortState.column = null;
                week.sortState.direction = null;

                // Restore original order
                this.restoreOriginalOrder();

                // Re-render and save
                this.render();
                this.debouncedSave();
            },

            restoreOriginalOrder() {
                const week = this.data.weeks[this.currentWeekStart];
                const { originalOrder } = week.sortState;

                // Build map for O(1) row lookup by ID
                const rowMap = new Map(week.rows.map(r => [r.id, r]));

                // Rebuild rows array in original order (skip any deleted IDs)
                week.rows = originalOrder
                    .filter(id => rowMap.has(id))
                    .map(id => rowMap.get(id));
            },

            applySortIfNeeded() {
                const week = this.data.weeks[this.currentWeekStart];
                if (!week || !week.sortState) return;

                const { column, direction } = week.sortState;

                // Apply active sort state when rendering week
                if (column && direction) {
                    const config = COLUMN_CONFIG[column];
                    if (config && config.sortable) {
                        this.applySortToRows(column, direction, config);
                    }
                }
            },

            updateSortIndicators() {
                const week = this.data.weeks[this.currentWeekStart];
                if (!week || !week.sortState) return;

                const { column, direction } = week.sortState;

                // Update all column header indicators
                Object.keys(COLUMN_CONFIG).forEach(col => {
                    if (!COLUMN_CONFIG[col].sortable) return;

                    const header = document.querySelector(`th[onclick="app.sortColumn('${col}')"]`);
                    const indicator = document.getElementById(`sort-${col}`);

                    if (header && indicator) {
                        if (col === column && direction) {
                            // Active sort column
                            indicator.textContent = direction === 'asc' ? '‚ñ≤' : '‚ñº';
                            indicator.classList.add('active');
                            header.setAttribute('aria-sort', direction === 'asc' ? 'ascending' : 'descending');
                        } else {
                            // Inactive sortable column
                            indicator.textContent = '‚ñæ';
                            indicator.classList.remove('active');
                            header.setAttribute('aria-sort', 'none');
                        }
                    }
                });
            },

            updateClearSortButton() {
                const week = this.data.weeks[this.currentWeekStart];
                const clearBtn = document.getElementById('clearSortBtn');

                if (clearBtn && week && week.sortState) {
                    // Show button only when sort is active
                    if (week.sortState.column && week.sortState.direction) {
                        clearBtn.style.display = 'inline-block';
                    } else {
                        clearBtn.style.display = 'none';
                    }
                }
            },

            // ==================== HIDE EMPTY ROWS ====================
            toggleHideEmptyRows() {
                this.hideEmptyRows = !this.hideEmptyRows;
                this.updateHideEmptyRowsButton();
                this.render();
            },

            updateHideEmptyRowsButton() {
                const btn = document.getElementById('hideEmptyRowsBtn');
                if (btn) {
                    if (this.hideEmptyRows) {
                        btn.classList.add('active');
                        btn.textContent = 'Showing Non-Empty ‚úì';
                        btn.title = 'Click to show all rows';
                    } else {
                        btn.classList.remove('active');
                        btn.textContent = 'Hide Empty Rows';
                        btn.title = 'Hide rows with no hours';
                    }
                }
            },

            rowHasHours(row) {
                return Object.values(row.hours).some(h => parseFloat(h) > 0);
            },

            // ==================== WEEK NAVIGATION ====================
            previousWeek() {
                const current = this.parseDate(this.currentWeekStart);
                current.setDate(current.getDate() - 7);
                this.currentWeekStart = this.formatDate(current);
                this.ensureWeekExists(this.currentWeekStart);
                this.data.preferences.lastWeekStart = this.currentWeekStart;
                this.render();
                this.saveData();
            },

            nextWeek() {
                const current = this.parseDate(this.currentWeekStart);
                current.setDate(current.getDate() + 7);
                this.currentWeekStart = this.formatDate(current);
                this.ensureWeekExists(this.currentWeekStart);
                this.data.preferences.lastWeekStart = this.currentWeekStart;
                this.render();
                this.saveData();
            },

            openWeekPicker() {
                // Use custom calendar modal instead of native date picker
                this.showCalendarModal();
            },

            jumpToWeek(dateString) {
                if (!dateString) return;

                // Parse the selected date
                const selectedDate = new Date(dateString + 'T00:00:00');

                // Calculate the Monday of the week containing this date
                const dayOfWeek = selectedDate.getDay();
                const diff = (dayOfWeek === 0 ? -6 : 1) - dayOfWeek; // Adjust when Sunday
                const monday = new Date(selectedDate);
                monday.setDate(selectedDate.getDate() + diff);

                // Format as YYYY-MM-DD
                const weekStart = this.formatDate(monday);

                // Navigate to this week
                this.currentWeekStart = weekStart;
                this.ensureWeekExists(this.currentWeekStart);
                this.data.preferences.lastWeekStart = this.currentWeekStart;
                this.render();
                this.saveData();
            },

            goToCurrentWeek() {
                const currentWeekStart = this.getCurrentWeekStart();
                this.currentWeekStart = currentWeekStart;
                this.ensureWeekExists(this.currentWeekStart);
                this.data.preferences.lastWeekStart = this.currentWeekStart;
                this.render();
                this.saveData();
            },

            // ==================== CUSTOM CALENDAR ====================

            // Calendar state
            calendarState: {
                displayedMonth: null,
                displayedYear: null,
                focusedDate: null
            },

            // Get total hours for a specific date across all rows
            getHoursForDate(date) {
                // Calculate the Monday of the week containing this date
                const day = date.getDay();
                const diff = (day === 0 ? -6 : 1) - day;
                const monday = new Date(date);
                monday.setDate(date.getDate() + diff);
                const weekStart = this.formatDate(monday);

                const week = this.data.weeks[weekStart];
                if (!week || !week.rows) return 0;

                // Determine day key (sun=0, mon=1, etc. -> our keys)
                const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                const dayKey = dayKeys[date.getDay()];

                // Sum all row hours for this day
                return week.rows.reduce((total, row) => {
                    return total + (parseFloat(row.hours[dayKey]) || 0);
                }, 0);
            },

            // Get background color based on hours (0=white, 8+=full green, linear scale)
            getCalendarCellColor(hours) {
                if (hours === 0) return 'transparent';
                if (hours >= 8) return 'hsl(120, 60%, 40%)';

                // Linear gradient: 1hr = lightest, 7hrs = near full
                // Lightness: 85% (light) ‚Üí 45% (darker)
                const lightness = 85 - ((hours / 8) * 40);
                return `hsl(120, 60%, ${lightness}%)`;
            },

            // Build calendar month data
            buildCalendarMonth(year, month) {
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);

                // Get the Monday before/on the first day of month
                let startDay = new Date(firstDay);
                const firstDayOfWeek = firstDay.getDay();
                // Adjust to Monday (if Sunday, go back 6 days; otherwise go back to Monday)
                const daysToMonday = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
                startDay.setDate(startDay.getDate() - daysToMonday);

                // Build 6 weeks of days (42 days total)
                const days = [];
                const currentDate = new Date(startDay);

                for (let i = 0; i < 42; i++) {
                    const date = new Date(currentDate);
                    days.push({
                        date: date,
                        day: date.getDate(),
                        isCurrentMonth: date.getMonth() === month,
                        hours: this.getHoursForDate(date)
                    });
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                return days;
            },

            // Show the calendar modal
            showCalendarModal() {
                const modal = document.getElementById('calendarModal');

                // Guard: if already open, close first to avoid listener accumulation
                if (modal.classList.contains('active')) {
                    this.closeCalendarModal();
                }

                // Initialize to the month of the currently displayed week
                const currentDate = this.parseDate(this.currentWeekStart);
                this.calendarState.displayedMonth = currentDate.getMonth();
                this.calendarState.displayedYear = currentDate.getFullYear();
                this.calendarState.focusedDate = null;

                this.renderCalendar();
                modal.classList.add('active');

                // Set up keyboard handler
                this.calendarKeyHandler = (e) => this.handleCalendarKeyboard(e);
                modal.addEventListener('keydown', this.calendarKeyHandler);

                // Close on backdrop click
                this.calendarBackdropHandler = (e) => {
                    if (e.target.id === 'calendarModal') {
                        this.closeCalendarModal();
                    }
                };
                modal.addEventListener('click', this.calendarBackdropHandler);

                // Focus the first day of current month or today
                requestAnimationFrame(() => {
                    const today = document.querySelector('.calendar-day.today');
                    const firstCurrentMonth = document.querySelector('.calendar-day:not(.other-month)');
                    const toFocus = today || firstCurrentMonth;
                    if (toFocus) {
                        toFocus.focus();
                        this.calendarState.focusedDate = toFocus.dataset.date;
                    }
                });
            },

            // Close the calendar modal
            closeCalendarModal() {
                const modal = document.getElementById('calendarModal');
                modal.classList.remove('active');

                // Remove event listeners
                if (this.calendarKeyHandler) {
                    modal.removeEventListener('keydown', this.calendarKeyHandler);
                }
                if (this.calendarBackdropHandler) {
                    modal.removeEventListener('click', this.calendarBackdropHandler);
                }

                // Return focus to the week display button
                document.getElementById('weekDisplay').focus();
            },

            // Render the calendar grid
            renderCalendar() {
                const { displayedMonth, displayedYear } = this.calendarState;
                const days = this.buildCalendarMonth(displayedYear, displayedMonth);

                // Update month/year header using native date formatting
                const headerDate = new Date(displayedYear, displayedMonth, 1);
                document.getElementById('calendarMonthYear').textContent =
                    headerDate.toLocaleDateString('en-AU', { month: 'long', year: 'numeric' });

                // Get today's date and current week dates for highlighting
                const today = new Date();
                const todayStr = this.formatDate(today);
                const currentWeekDates = this.getWeekDates(this.currentWeekStart).map(d => this.formatDate(d));

                // Build day cells HTML
                const grid = document.getElementById('calendarGrid');

                // Remove existing day cells (keep weekday headers)
                grid.querySelectorAll('.calendar-day').forEach(el => el.remove());

                // Add day cells
                days.forEach(dayInfo => {
                    const dateStr = this.formatDate(dayInfo.date);
                    const cell = document.createElement('div');
                    cell.className = 'calendar-day';
                    cell.textContent = dayInfo.day;
                    cell.dataset.date = dateStr;
                    cell.setAttribute('role', 'gridcell');
                    cell.setAttribute('tabindex', '-1');

                    // Build aria-label for accessibility using native date formatting
                    const ariaLabel = dayInfo.date.toLocaleDateString('en-AU', {
                        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
                    }) + (dayInfo.hours > 0 ? `, ${dayInfo.hours} hours logged` : '');
                    cell.setAttribute('aria-label', ariaLabel);

                    // Apply classes
                    if (!dayInfo.isCurrentMonth) {
                        cell.classList.add('other-month');
                    }
                    if (dateStr === todayStr) {
                        cell.classList.add('today');
                    }
                    if (currentWeekDates.includes(dateStr)) {
                        cell.classList.add('current-week');
                    }

                    // Apply background color based on hours
                    const bgColor = this.getCalendarCellColor(dayInfo.hours);
                    if (bgColor !== 'transparent') {
                        cell.style.backgroundColor = bgColor;
                        // Adjust text color for darker backgrounds
                        if (dayInfo.hours >= 5) {
                            cell.style.color = 'white';
                        }
                    }

                    // Click handler
                    cell.addEventListener('click', () => {
                        this.selectCalendarDate(dateStr);
                    });

                    grid.appendChild(cell);
                });
            },

            // Navigate calendar months
            navigateCalendarMonth(direction) {
                this.calendarState.displayedMonth += direction;

                if (this.calendarState.displayedMonth > 11) {
                    this.calendarState.displayedMonth = 0;
                    this.calendarState.displayedYear++;
                } else if (this.calendarState.displayedMonth < 0) {
                    this.calendarState.displayedMonth = 11;
                    this.calendarState.displayedYear--;
                }

                this.renderCalendar();

                // Focus first day of new month
                requestAnimationFrame(() => {
                    const firstDay = document.querySelector('.calendar-day:not(.other-month)');
                    if (firstDay) {
                        firstDay.focus();
                        this.calendarState.focusedDate = firstDay.dataset.date;
                    }
                });
            },

            // Select a date and jump to that week
            selectCalendarDate(dateString) {
                this.closeCalendarModal();
                this.jumpToWeek(dateString);
            },

            // Keyboard navigation for calendar
            handleCalendarKeyboard(e) {
                // Escape closes the modal from anywhere
                if (e.key === 'Escape') {
                    e.preventDefault();
                    this.closeCalendarModal();
                    return;
                }

                // Only handle other keys if focused on a day cell
                const focusedElement = document.activeElement;
                if (!focusedElement.classList.contains('calendar-day')) return;

                const currentDate = focusedElement.dataset.date;
                if (!currentDate) return;

                const current = this.parseDate(currentDate);
                let newDate = null;

                // Arrow key offsets (days to move)
                const arrowOffsets = { ArrowLeft: -1, ArrowRight: 1, ArrowUp: -7, ArrowDown: 7 };

                if (arrowOffsets[e.key] !== undefined) {
                    e.preventDefault();
                    newDate = new Date(current);
                    newDate.setDate(newDate.getDate() + arrowOffsets[e.key]);
                } else if (e.key === 'PageUp') {
                    e.preventDefault();
                    this.navigateCalendarMonth(-1);
                    return;
                } else if (e.key === 'PageDown') {
                    e.preventDefault();
                    this.navigateCalendarMonth(1);
                    return;
                } else if (e.key === 'Home') {
                    e.preventDefault();
                    newDate = new Date(this.calendarState.displayedYear, this.calendarState.displayedMonth, 1);
                } else if (e.key === 'End') {
                    e.preventDefault();
                    newDate = new Date(this.calendarState.displayedYear, this.calendarState.displayedMonth + 1, 0);
                } else if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.selectCalendarDate(currentDate);
                    return;
                }

                if (newDate) {
                    const newDateStr = this.formatDate(newDate);

                    // Navigate months if needed
                    if (newDate.getMonth() !== this.calendarState.displayedMonth ||
                        newDate.getFullYear() !== this.calendarState.displayedYear) {
                        this.calendarState.displayedMonth = newDate.getMonth();
                        this.calendarState.displayedYear = newDate.getFullYear();
                        this.renderCalendar();
                    }

                    // Focus the new date
                    requestAnimationFrame(() => {
                        const newCell = document.querySelector(`.calendar-day[data-date="${newDateStr}"]`);
                        if (newCell) {
                            newCell.focus();
                            this.calendarState.focusedDate = newDateStr;
                        }
                    });
                }
            },

            // ==================== VALIDATION ====================

            // Export-only validation: checks required fields for rows with hours
            validateRequiredFieldsForExport() {
                const currentWeek = this.data.weeks[this.currentWeekStart];
                const errors = [];
                const dayNames = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                const requiredFields = [
                    { field: 'project', label: 'Project' },
                    { field: 'projectTask', label: 'Project Task' },
                    { field: 'cbs', label: 'CBS' },
                    { field: 'role', label: 'Role' },
                    { field: 'type', label: 'Type' },
                    { field: 'description', label: 'Description' }
                ];

                currentWeek.rows.forEach((row, index) => {
                    // Check if row has any hours
                    const totalHours = dayNames.reduce((sum, day) =>
                        sum + (parseFloat(row.hours[day]) || 0), 0);

                    if (totalHours === 0) {
                        return; // Skip rows with no hours
                    }

                    // Check each required field
                    const missingFields = [];
                    requiredFields.forEach(({ field, label }) => {
                        const value = row[field];
                        if (!value || value.trim() === '') {
                            missingFields.push(label);

                            // Highlight the field - handle both input and select elements
                            const selector = `[data-field="${field}"][data-row="${row.id}"]`;
                            const element = document.querySelector(selector);
                            if (element) {
                                element.classList.add('validation-error');
                            }
                        }
                    });

                    if (missingFields.length > 0) {
                        errors.push({
                            message: `Row ${index + 1}: Missing required fields: ${missingFields.join(', ')}`,
                            rowId: row.id
                        });
                    }
                });

                // Update validation panel if there are errors
                if (errors.length > 0) {
                    const panel = document.getElementById('validationPanel');
                    const list = document.getElementById('validationList');

                    errors.forEach(issue => {
                        const li = document.createElement('li');
                        li.textContent = issue.message;
                        list.appendChild(li);
                    });

                    panel.className = 'validation-panel has-errors';
                }

                return errors.length === 0;
            },

            validateAndDisplay() {
                const currentWeek = this.data.weeks[this.currentWeekStart];
                const errors = [];
                const warnings = [];

                // Clear previous validation styling
                document.querySelectorAll('.validation-error, .validation-warning').forEach(el => {
                    el.classList.remove('validation-error', 'validation-warning');
                });

                currentWeek.rows.forEach((row, index) => {
                    CONFIG.validationRules.forEach(rule => {
                        // Pass currentWeek for cross-row validation (backward compatible)
                        const testResult = rule.test.length > 1
                            ? rule.test.call(rule, row, currentWeek)
                            : rule.test(row);

                        // Handle both boolean and rich result object
                        const passed = typeof testResult === 'boolean' ? testResult : testResult.pass;

                        if (!passed) {
                            // Generate dynamic message for Agile Accrual rule
                            let message = rule.message;
                            if (rule.id === 'agileAccrualRequires8Hours' && typeof testResult === 'object') {
                                message = `Insufficient Work hours for Agile Accrual on ${testResult.violationDay}: need 8, have ${testResult.violationWorkHours}`;
                            }

                            const issue = { message: `Row ${index + 1}: ${message}`, rowId: row.id };
                            if (rule.level === 'error') {
                                errors.push(issue);
                            } else {
                                warnings.push(issue);
                            }

                            // Highlight the description field if it's the resource pool rule
                            if (rule.id === 'resourcePoolDescription') {
                                const input = document.querySelector(`input[data-field="description"][data-row="${row.id}"]`);
                                if (input) {
                                    input.classList.add('validation-error');
                                }
                            }
                        }
                    });
                });

                const panel = document.getElementById('validationPanel');
                const list = document.getElementById('validationList');
                list.innerHTML = '';

                if (errors.length > 0 || warnings.length > 0) {
                    [...errors, ...warnings].forEach(issue => {
                        const li = document.createElement('li');
                        li.textContent = issue.message;
                        list.appendChild(li);
                    });

                    panel.className = 'validation-panel';
                    if (errors.length > 0) {
                        panel.classList.add('has-errors');
                    } else {
                        panel.classList.add('has-warnings');
                    }
                } else {
                    panel.className = 'validation-panel';
                }

                return errors.length === 0;
            },

            // ==================== CSV EXPORT ====================
            exportCSV() {
                // Run existing validation first (clears previous styling)
                const existingValid = this.validateAndDisplay();
                // Then check required fields for rows with hours (appends to panel)
                const requiredFieldsValid = this.validateRequiredFieldsForExport();

                if (!existingValid || !requiredFieldsValid) {
                    alert('Please fix validation errors before exporting.');
                    return;
                }

                // Calculate total hours for the week
                const currentWeek = this.data.weeks[this.currentWeekStart];
                const dayNames = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                let totalHours = 0;
                currentWeek.rows.forEach(row => {
                    dayNames.forEach(day => {
                        totalHours += parseFloat(row.hours[day] || 0);
                    });
                });

                // Check if total hours is less than expected
                const expectedHours = this.data.preferences.expectedWeeklyHours;
                if (expectedHours > 0 && totalHours < expectedHours) {
                    this.showExportWarningModal(totalHours, expectedHours);
                    return;
                }

                // Proceed with export
                this.proceedWithExport();
            },

            proceedWithExport() {
                const currentWeek = this.data.weeks[this.currentWeekStart];
                const weekDates = this.getWeekDates(this.currentWeekStart);
                const dayNames = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

                // CSV header
                let csv = '(Do Not Modify) Time Entry,(Do Not Modify) Row Checksum,(Do Not Modify) Modified On,Time Source,Project,Project Task,Cost Type,CBS,Role,Type,Entry Status,Date,Duration,Description,External Comments,Work Location\n';

                // Generate rows
                currentWeek.rows.forEach(row => {
                    dayNames.forEach((day, dayIndex) => {
                        const hours = parseFloat(row.hours[day] || 0);
                        if (hours > 0) {
                            const date = weekDates[dayIndex];
                            const dateStr = this.formatCSVDate(date);
                            const duration = Math.round(hours * 60); // Convert to minutes

                            csv += `,,,"${CONFIG.csvDefaults.timeSource}","${row.project}","${row.projectTask}","${this.getCostType()}","${row.cbs}","${row.role}","${row.type}","${CONFIG.csvDefaults.entryStatus}",${dateStr},${duration},"${row.description}","${row.description}","${this.getWorkLocationCode()}"\n`;
                        }
                    });
                });

                // Download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Timesheet_${this.currentWeekStart}.csv`;
                a.click();
                URL.revokeObjectURL(url);

                // Close modal if it was open
                this.closeExportWarningModal();
            },

            showExportWarningModal(totalHours, expectedHours) {
                document.getElementById('modalTotalHours').textContent = totalHours.toFixed(1);
                document.getElementById('modalExpectedHours').textContent = expectedHours.toFixed(1);
                document.getElementById('exportWarningModal').classList.add('active');
            },

            closeExportWarningModal() {
                document.getElementById('exportWarningModal').classList.remove('active');
            },

            // ==================== DELETE OLD WEEKS ====================
            showDeleteOldWeeksModal() {
                document.getElementById('deleteWeeksThreshold').value = 12;
                this.updateDeleteOldWeeksPreview();
                document.getElementById('deleteOldWeeksModal').classList.add('active');
            },

            closeDeleteOldWeeksModal() {
                document.getElementById('deleteOldWeeksModal').classList.remove('active');
            },

            getWeeksToDelete(thresholdWeeks) {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize to midnight for consistent comparison
                const cutoffDate = new Date(today);
                cutoffDate.setDate(cutoffDate.getDate() - (thresholdWeeks * 7));

                const weeksToDelete = [];
                const weekKeys = Object.keys(this.data.weeks).sort();

                for (const weekKey of weekKeys) {
                    // Skip current week
                    if (weekKey === this.currentWeekStart) {
                        continue;
                    }

                    const weekDate = this.parseDate(weekKey);
                    if (weekDate < cutoffDate) {
                        const week = this.data.weeks[weekKey];
                        const rowCount = week.rows ? week.rows.length : 0;
                        weeksToDelete.push({
                            key: weekKey,
                            rowCount: rowCount
                        });
                    }
                }

                return weeksToDelete;
            },

            formatWeekRange(weekStartStr) {
                const startDate = new Date(weekStartStr);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);

                const options = { month: 'short', day: 'numeric' };
                const startFormatted = startDate.toLocaleDateString('en-US', options);
                const endFormatted = endDate.toLocaleDateString('en-US', options);
                const year = startDate.getFullYear();

                return `${startFormatted} - ${endFormatted}, ${year}`;
            },

            updateDeleteOldWeeksPreview() {
                const threshold = parseInt(document.getElementById('deleteWeeksThreshold').value) || 12;
                const weeksToDelete = this.getWeeksToDelete(threshold);
                const previewDiv = document.getElementById('deleteOldWeeksPreview');
                const deleteBtn = document.getElementById('confirmDeleteWeeksBtn');

                if (weeksToDelete.length === 0) {
                    previewDiv.innerHTML = '<p style="color: #666; font-style: italic;">No weeks found older than ' + threshold + ' weeks.</p>';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.disabled = true;
                    deleteBtn.style.opacity = '0.5';
                    deleteBtn.style.cursor = 'not-allowed';
                } else {
                    let html = '<p style="margin-bottom: 10px;"><strong>The following ' + weeksToDelete.length + ' week(s) will be deleted:</strong></p>';
                    html += '<ul style="list-style: disc; margin-left: 20px; line-height: 1.6;">';
                    for (const week of weeksToDelete) {
                        html += '<li>Week of ' + this.formatWeekRange(week.key) + ' (' + week.rowCount + ' row' + (week.rowCount !== 1 ? 's' : '') + ')</li>';
                    }
                    html += '</ul>';
                    previewDiv.innerHTML = html;
                    deleteBtn.textContent = 'Delete ' + weeksToDelete.length + ' Week' + (weeksToDelete.length !== 1 ? 's' : '');
                    deleteBtn.disabled = false;
                    deleteBtn.style.opacity = '1';
                    deleteBtn.style.cursor = 'pointer';
                }
            },

            confirmDeleteOldWeeks() {
                const threshold = parseInt(document.getElementById('deleteWeeksThreshold').value) || 12;
                const weeksToDelete = this.getWeeksToDelete(threshold);

                if (weeksToDelete.length === 0) {
                    return;
                }

                // Delete the weeks
                for (const week of weeksToDelete) {
                    delete this.data.weeks[week.key];
                }

                // Save and close
                this.saveData();
                this.closeDeleteOldWeeksModal();

                // Show confirmation
                alert('Deleted ' + weeksToDelete.length + ' week' + (weeksToDelete.length !== 1 ? 's' : '') + ' of data.');
            },

            // ==================== DELETE EMPTY ROWS ====================
            getEmptyRows() {
                const week = this.data.weeks[this.currentWeekStart];
                if (!week || !week.rows) return [];

                return week.rows.filter(row => {
                    const total = parseFloat(this.getRowTotal(row)) || 0;
                    return total === 0;
                });
            },

            showDeleteEmptyRowsModal() {
                const emptyRows = this.getEmptyRows();
                const messageEl = document.getElementById('deleteEmptyRowsMessage');
                const confirmBtn = document.getElementById('confirmDeleteEmptyRowsBtn');

                if (emptyRows.length === 0) {
                    messageEl.innerHTML = 'There are no empty rows to delete in the current week.';
                    confirmBtn.style.display = 'none';
                } else {
                    messageEl.innerHTML = `This will delete <strong>${emptyRows.length}</strong> row${emptyRows.length !== 1 ? 's' : ''} that have no hours assigned.`;
                    confirmBtn.style.display = 'inline-block';
                }

                document.getElementById('deleteEmptyRowsModal').classList.add('active');
            },

            closeDeleteEmptyRowsModal() {
                document.getElementById('deleteEmptyRowsModal').classList.remove('active');
            },

            confirmDeleteEmptyRows() {
                const week = this.data.weeks[this.currentWeekStart];
                if (!week || !week.rows) {
                    this.closeDeleteEmptyRowsModal();
                    return;
                }

                const originalCount = week.rows.length;
                week.rows = week.rows.filter(row => {
                    const total = parseFloat(this.getRowTotal(row)) || 0;
                    return total > 0;
                });
                const deletedCount = originalCount - week.rows.length;

                this.saveData();
                this.renderTable();
                this.closeDeleteEmptyRowsModal();

                if (deletedCount > 0) {
                    alert('Deleted ' + deletedCount + ' empty row' + (deletedCount !== 1 ? 's' : '') + '.');
                }
            },

            // ==================== CLEAR ALL HOURS ====================
            getTotalHoursInWeek() {
                const week = this.data.weeks[this.currentWeekStart];
                if (!week || !week.rows) return 0;

                return week.rows.reduce((total, row) => {
                    return total + (parseFloat(this.getRowTotal(row)) || 0);
                }, 0);
            },

            showClearAllHoursModal() {
                const totalHours = this.getTotalHoursInWeek();
                const week = this.data.weeks[this.currentWeekStart];
                const rowCount = week?.rows?.length || 0;
                const messageEl = document.getElementById('clearAllHoursMessage');
                const confirmBtn = document.getElementById('confirmClearAllHoursBtn');

                if (totalHours === 0) {
                    messageEl.innerHTML = 'There are no hours to clear in the current week.';
                    confirmBtn.style.display = 'none';
                } else {
                    messageEl.innerHTML = `This will clear <strong>${totalHours.toFixed(1)}</strong> hours across <strong>${rowCount}</strong> row${rowCount !== 1 ? 's' : ''} in the current week.`;
                    confirmBtn.style.display = 'inline-block';
                }

                document.getElementById('clearAllHoursModal').classList.add('active');
            },

            closeClearAllHoursModal() {
                document.getElementById('clearAllHoursModal').classList.remove('active');
            },

            confirmClearAllHours() {
                const week = this.data.weeks[this.currentWeekStart];
                if (!week || !week.rows) {
                    this.closeClearAllHoursModal();
                    return;
                }

                const totalCleared = this.getTotalHoursInWeek();

                // Clear all hours in all rows
                week.rows.forEach(row => {
                    row.hours = {
                        mon: 0,
                        tue: 0,
                        wed: 0,
                        thu: 0,
                        fri: 0,
                        sat: 0,
                        sun: 0
                    };
                });

                this.saveData();
                this.renderTable();
                this.closeClearAllHoursModal();

                if (totalCleared > 0) {
                    alert('Cleared ' + totalCleared.toFixed(1) + ' hours from all rows.');
                }
            },

            formatCSVDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            },

            // ==================== JSON IMPORT/EXPORT ====================
            compactData(data) {
                // Create a deep copy to avoid modifying original data
                const compacted = JSON.parse(JSON.stringify(data));

                // Helper: Check if a row is completely empty
                const isEmptyRow = (row) => {
                    const hasAnyHours = Object.values(row.hours || {}).some(h => h > 0);
                    const hasAnyData = row.project || row.projectTask ||
                                     row.cbs || row.role || row.type || row.description;
                    return !hasAnyHours && !hasAnyData;
                };

                // Helper: Check if a week should be omitted (only empty rows)
                const isEmptyWeek = (week) => {
                    return week.rows.every(row => isEmptyRow(row));
                };

                // Process weeks
                const compactedWeeks = {};
                for (const [weekKey, week] of Object.entries(compacted.weeks || {})) {
                    // Skip completely empty weeks
                    if (isEmptyWeek(week)) {
                        continue;
                    }

                    // Compact each row in the week
                    const compactedRows = week.rows.map(row => {
                        const compactedRow = { id: row.id };

                        // Only include non-empty string fields
                        const fields = ['project', 'projectTask', 'cbs', 'role', 'type', 'description'];
                        fields.forEach(field => {
                            if (row[field] && row[field] !== '') {
                                compactedRow[field] = row[field];
                            }
                        });

                        // Only include non-zero hours
                        const compactedHours = {};
                        const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                        days.forEach(day => {
                            if (row.hours && row.hours[day] && row.hours[day] !== 0) {
                                compactedHours[day] = row.hours[day];
                            }
                        });

                        // Only include hours object if it has any data
                        if (Object.keys(compactedHours).length > 0) {
                            compactedRow.hours = compactedHours;
                        } else {
                            compactedRow.hours = {};
                        }

                        return compactedRow;
                    });

                    compactedWeeks[weekKey] = {
                        weekStart: week.weekStart,
                        rows: compactedRows
                    };
                }

                compacted.weeks = compactedWeeks;
                return compacted;
            },

            expandData(data) {
                // Create a deep copy to avoid modifying imported data
                const expanded = JSON.parse(JSON.stringify(data));

                // Ensure weeks object exists
                if (!expanded.weeks) {
                    expanded.weeks = {};
                }

                // Process each week to fill in missing fields
                for (const [weekKey, week] of Object.entries(expanded.weeks)) {
                    week.rows = week.rows.map(row => {
                        // Ensure all string fields exist (default to empty string)
                        const fields = ['project', 'projectTask', 'cbs', 'role', 'type', 'description'];
                        fields.forEach(field => {
                            if (!row.hasOwnProperty(field)) {
                                row[field] = '';
                            }
                        });

                        // Ensure hours object exists with all days
                        if (!row.hours) {
                            row.hours = {};
                        }

                        const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                        days.forEach(day => {
                            if (!row.hours.hasOwnProperty(day)) {
                                row.hours[day] = 0;
                            }
                        });

                        return row;
                    });
                }

                return expanded;
            },

            exportJSON() {
                const compacted = this.compactData(this.data);
                const json = JSON.stringify(compacted, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `KBR_Timesheet_Backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            importJSON() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const imported = JSON.parse(event.target.result);
                                if (confirm('This will replace all current data. Are you sure?')) {
                                    // Expand compacted data to ensure all fields are present
                                    this.data = this.expandData(imported);
                                    this.currentWeekStart = this.data.preferences.lastWeekStart || this.getCurrentWeekStart();
                                    this.ensureWeekExists(this.currentWeekStart);
                                    this.render();
                                    this.saveData();
                                }
                            } catch (error) {
                                alert('Invalid JSON file. Please check the file and try again.');
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            },

            // ==================== EXPECTED HOURS ====================
            showExpectedHoursModal() {
                const modal = document.getElementById('expectedHoursModal');
                const input = document.getElementById('expectedHoursInput');
                input.value = this.data.preferences.expectedWeeklyHours;
                modal.classList.add('active');
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 100);
            },

            saveExpectedHours() {
                const input = document.getElementById('expectedHoursInput');
                const value = parseFloat(input.value);

                if (isNaN(value) || value < 0) {
                    alert('Please enter a valid positive number');
                    return;
                }

                this.data.preferences.expectedWeeklyHours = value;
                document.getElementById('expectedHoursValue').textContent = value;

                this.saveData();
                this.closeExpectedHoursModal();
            },

            closeExpectedHoursModal() {
                document.getElementById('expectedHoursModal').classList.remove('active');
            },

            // ==================== WORK LOCATION ====================
            showWorkLocationModal() {
                const modal = document.getElementById('workLocationModal');
                const select = document.getElementById('workLocationSelect');
                select.value = this.data.preferences.workLocation || 'brisbane';
                modal.classList.add('active');
            },

            saveWorkLocation() {
                const select = document.getElementById('workLocationSelect');
                const locationKey = select.value;
                this.data.preferences.workLocation = locationKey;
                this.updateWorkLocationDisplay();
                this.saveData();
                this.closeWorkLocationModal();
            },

            closeWorkLocationModal() {
                document.getElementById('workLocationModal').classList.remove('active');
            },

            updateWorkLocationDisplay() {
                const locationKey = this.data.preferences.workLocation || 'brisbane';
                const location = CONFIG.workLocations[locationKey];
                document.getElementById('workLocationValue').textContent =
                    `${location.name} (${location.code})`;
            },

            getWorkLocationCode() {
                const locationKey = this.data.preferences.workLocation || 'brisbane';
                return CONFIG.workLocations[locationKey].code;
            },

            getLocationStatePrefix() {
                const locationKey = this.data.preferences.workLocation || 'brisbane';
                return CONFIG.workLocations[locationKey].statePrefix;
            },

            resolveTemplateFields(template) {
                if (!template.locationDynamic) {
                    return template.fields || template;
                }

                const statePrefix = this.getLocationStatePrefix();
                const fields = template.fields || template;
                const resolved = {};

                for (const [key, value] of Object.entries(fields)) {
                    if (typeof value === 'string') {
                        resolved[key] = value.replace(/\{STATE\}/g, statePrefix);
                    } else {
                        resolved[key] = value;
                    }
                }

                return resolved;
            },

            // ==================== COST TYPE ====================
            showCostTypeModal() {
                const modal = document.getElementById('costTypeModal');
                const select = document.getElementById('costTypeSelect');
                select.value = this.data.preferences.costType || '';
                modal.classList.add('active');
            },

            saveCostType() {
                const select = document.getElementById('costTypeSelect');
                const costTypeKey = select.value;
                this.data.preferences.costType = costTypeKey;
                this.updateCostTypeDisplay();
                this.saveData();
                this.closeCostTypeModal();
            },

            closeCostTypeModal() {
                document.getElementById('costTypeModal').classList.remove('active');
            },

            updateCostTypeDisplay() {
                const costTypeKey = this.data.preferences.costType;
                if (costTypeKey && CONFIG.costTypes[costTypeKey]) {
                    const costType = CONFIG.costTypes[costTypeKey];
                    document.getElementById('costTypeValue').textContent =
                        `${costType.name} (${costType.code})`;
                } else {
                    document.getElementById('costTypeValue').textContent = 'Not set';
                }
            },

            getCostType() {
                const costTypeKey = this.data.preferences.costType;
                if (costTypeKey && CONFIG.costTypes[costTypeKey]) {
                    return CONFIG.costTypes[costTypeKey].code;
                }
                return '';
            },

            // ==================== TEMPLATES ====================
            showTemplates() {
                const modal = document.getElementById('templateModal');
                this.renderTemplateList();
                modal.classList.add('active');
            },

            closeTemplateModal() {
                document.getElementById('templateModal').classList.remove('active');
            },

            renderTemplateList() {
                const list = document.getElementById('templateList');
                list.innerHTML = '';

                // Merge predefined and custom templates (predefined first)
                const allTemplates = [
                    ...CONFIG.predefinedTemplates,
                    ...this.data.templates
                ];

                if (allTemplates.length === 0) {
                    list.innerHTML = '<li>No templates available</li>';
                    return;
                }

                allTemplates.forEach(template => {
                    const li = document.createElement('li');
                    li.className = 'template-item';

                    // Get project name from template (handle both old and new structure)
                    // For locationDynamic templates, resolve the {STATE} placeholder
                    const resolvedFields = this.resolveTemplateFields(template);
                    const projectName = resolvedFields.project || template.project || '';

                    if (template.predefined) {
                        // Predefined template: Use + Copy & Edit buttons
                        li.innerHTML = `
                            <span><strong>${template.name}</strong> - ${projectName}</span>
                            <div class="template-actions">
                                <button class="btn" onclick="app.useTemplate('${template.id}')">Use</button>
                                <button class="btn btn-secondary" onclick="app.copyAndEditTemplate('${template.id}')">Copy & Edit</button>
                            </div>
                        `;
                    } else {
                        // Custom template: Use + Edit + Delete buttons
                        li.innerHTML = `
                            <span><strong>${template.name}</strong> - ${projectName}</span>
                            <div class="template-actions">
                                <button class="btn" onclick="app.useTemplate('${template.id}')">Use</button>
                                <button class="btn btn-secondary" onclick="app.editTemplate('${template.id}')">Edit</button>
                                <button class="btn btn-danger" onclick="app.deleteTemplate('${template.id}')">Delete</button>
                            </div>
                        `;
                    }

                    list.appendChild(li);
                });
            },

            showSaveTemplate() {
                const modal = document.getElementById('saveTemplateModal');
                const select = document.getElementById('templateRow');
                select.innerHTML = '';

                const currentWeek = this.data.weeks[this.currentWeekStart];
                currentWeek.rows.forEach((row, index) => {
                    const option = document.createElement('option');
                    option.value = row.id;
                    option.textContent = `Row ${index + 1} - ${row.project || '(empty)'}`;
                    select.appendChild(option);
                });

                modal.classList.add('active');
                this.closeTemplateModal();
            },

            closeSaveTemplateModal() {
                document.getElementById('saveTemplateModal').classList.remove('active');
                document.getElementById('templateName').value = '';
            },

            saveTemplate() {
                const name = document.getElementById('templateName').value.trim();
                const rowId = document.getElementById('templateRow').value;

                if (!name) {
                    alert('Please enter a template name');
                    return;
                }

                const currentWeek = this.data.weeks[this.currentWeekStart];
                const row = currentWeek.rows.find(r => r.id === rowId);

                if (row) {
                    const template = {
                        id: 'tmpl-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                        name: name,
                        project: row.project,
                        projectTask: row.projectTask,
                        cbs: row.cbs,
                        role: row.role,
                        type: row.type,
                        description: row.description
                    };

                    this.data.templates.push(template);
                    this.saveData();
                    this.closeSaveTemplateModal();
                    alert('Template saved successfully!');
                }
            },

            useTemplate(templateId) {
                // Check both predefined and custom templates
                let template = CONFIG.predefinedTemplates.find(t => t.id === templateId);
                if (!template) {
                    template = this.data.templates.find(t => t.id === templateId);
                }
                if (!template) return;

                const currentWeek = this.data.weeks[this.currentWeekStart];
                const newRow = this.createEmptyRow();

                // Resolve template fields (handles {STATE} placeholder for locationDynamic templates)
                const fields = this.resolveTemplateFields(template);
                newRow.project = fields.project || '';
                newRow.projectTask = fields.projectTask || '';
                newRow.cbs = fields.cbs || '';
                newRow.role = fields.role || '';
                newRow.type = fields.type || '';
                newRow.description = fields.description || '';

                currentWeek.rows.push(newRow);
                currentWeek.sortState.originalOrder.push(newRow.id);
                this.render();
                this.saveData();
                this.closeTemplateModal();
            },

            deleteTemplate(templateId) {
                // Prevent deletion of predefined templates
                const isPredefined = CONFIG.predefinedTemplates.some(t => t.id === templateId);
                if (isPredefined) {
                    alert('Cannot delete predefined templates. Use "Copy & Edit" to create a custom version.');
                    return;
                }

                if (confirm('Are you sure you want to delete this template?')) {
                    this.data.templates = this.data.templates.filter(t => t.id !== templateId);
                    this.saveData();
                    this.renderTemplateList();
                }
            },

            copyAndEditTemplate(templateId) {
                // Find the predefined template
                const predefinedTemplate = CONFIG.predefinedTemplates.find(t => t.id === templateId);
                if (!predefinedTemplate) return;

                // Resolve template fields (handles {STATE} placeholder for locationDynamic templates)
                const resolvedFields = this.resolveTemplateFields(predefinedTemplate);

                // Create a copy as a custom template with resolved values
                const newTemplate = {
                    id: 'tmpl-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    name: predefinedTemplate.name + ' (Copy)',
                    project: resolvedFields.project,
                    projectTask: resolvedFields.projectTask,
                    cbs: resolvedFields.cbs,
                    role: resolvedFields.role,
                    type: resolvedFields.type,
                    description: resolvedFields.description
                };

                this.data.templates.push(newTemplate);
                this.saveData();

                // Open edit modal for the new copy
                this.editTemplate(newTemplate.id);
            },

            editTemplate(templateId) {
                // Only allow editing custom templates
                const template = this.data.templates.find(t => t.id === templateId);
                if (!template) return;

                // Populate dropdowns in edit modal
                this.populateEditTemplateDropdowns();

                // Populate form with template data
                document.getElementById('editTemplateName').value = template.name || '';
                document.getElementById('editTemplateProject').value = template.project || '';
                document.getElementById('editTemplateProjectTask').value = template.projectTask || '';
                document.getElementById('editTemplateCbs').value = template.cbs || '';
                document.getElementById('editTemplateRole').value = template.role || '';
                document.getElementById('editTemplateType').value = template.type || '';
                document.getElementById('editTemplateDescription').value = template.description || '';
                document.getElementById('editTemplateId').value = templateId;

                // Show modal
                document.getElementById('editTemplateModal').classList.add('active');
                this.closeTemplateModal();
            },

            populateEditTemplateDropdowns() {
                // Populate CBS dropdown (allow blank)
                const cbsSelect = document.getElementById('editTemplateCbs');
                cbsSelect.innerHTML = '<option value="">-- Select or leave blank --</option>';
                CONFIG.dropdownOptions.cbs.forEach(option => {
                    cbsSelect.innerHTML += `<option value="${option}">${option}</option>`;
                });

                // Populate Role dropdown
                const roleSelect = document.getElementById('editTemplateRole');
                roleSelect.innerHTML = '<option value="">-- Select --</option>';
                CONFIG.dropdownOptions.role.forEach(option => {
                    roleSelect.innerHTML += `<option value="${option}">${option}</option>`;
                });

                // Populate Type dropdown
                const typeSelect = document.getElementById('editTemplateType');
                typeSelect.innerHTML = '<option value="">-- Select --</option>';
                CONFIG.dropdownOptions.type.forEach(option => {
                    typeSelect.innerHTML += `<option value="${option}">${option}</option>`;
                });
            },

            closeEditTemplateModal() {
                document.getElementById('editTemplateModal').classList.remove('active');
            },

            saveEditedTemplate() {
                const templateId = document.getElementById('editTemplateId').value;
                const name = document.getElementById('editTemplateName').value.trim();
                const project = document.getElementById('editTemplateProject').value.trim();
                const projectTask = document.getElementById('editTemplateProjectTask').value.trim();
                const cbs = document.getElementById('editTemplateCbs').value;
                const role = document.getElementById('editTemplateRole').value;
                const type = document.getElementById('editTemplateType').value;
                const description = document.getElementById('editTemplateDescription').value.trim();

                if (!name) {
                    alert('Please enter a template name');
                    return;
                }

                // Find and update the template
                const template = this.data.templates.find(t => t.id === templateId);
                if (template) {
                    template.name = name;
                    template.project = project;
                    template.projectTask = projectTask;
                    template.cbs = cbs;
                    template.role = role;
                    template.type = type;
                    template.description = description;

                    this.saveData();
                    this.renderTemplateList();
                    this.closeEditTemplateModal();
                }
            },

            // ==================== COPY FROM OTHER WEEK ====================
            showCopyFromWeek() {
                const modal = document.getElementById('copyFromWeekModal');
                this.populateWeekSelector();
                modal.classList.add('active');
            },

            closeCopyFromWeekModal() {
                document.getElementById('copyFromWeekModal').classList.remove('active');
                document.getElementById('weekRowsContainer').classList.add('hidden');
            },

            populateWeekSelector() {
                const select = document.getElementById('weekSelector');
                select.innerHTML = '<option value="">-- Select a week --</option>';

                // Prefilter to only include weeks with hours data
                const allWeeks = Object.keys(this.data.weeks).sort().reverse();
                const weeksWithData = allWeeks.filter(weekStart => this.hasWeekData(weekStart));

                weeksWithData.forEach(weekStart => {
                    const weekDates = this.getWeekDates(weekStart);
                    const startStr = this.formatDisplayDate(weekStart);
                    const endDate = weekDates[6];
                    const endStr = this.formatDisplayDate(this.formatDate(endDate));

                    const option = document.createElement('option');
                    option.value = weekStart;
                    option.textContent = `Week of ${startStr} - ${endStr}`;

                    if (weekStart === this.currentWeekStart) {
                        option.textContent += ' (Current)';
                    }

                    select.appendChild(option);
                });
            },

            loadWeekRows() {
                const weekStart = document.getElementById('weekSelector').value;
                if (!weekStart) {
                    document.getElementById('weekRowsContainer').classList.add('hidden');
                    return;
                }

                const container = document.getElementById('weekRowsContainer');
                const list = document.getElementById('weekRowsList');

                const week = this.data.weeks[weekStart];
                if (!week || !week.rows || week.rows.length === 0) {
                    list.innerHTML = '<p style="padding: 20px; text-align: center;">No rows in this week</p>';
                    container.classList.remove('hidden');
                    return;
                }

                list.innerHTML = '';
                week.rows.forEach((row, index) => {
                    const total = this.getRowTotal(row);
                    const item = document.createElement('div');
                    item.className = 'week-row-item';
                    item.innerHTML = `
                        <input type="checkbox" class="week-row-checkbox" data-row-index="${index}">
                        <div class="week-row-details">
                            <strong>${row.project || '(No project)'} - ${row.description || '(No description)'}</strong>
                            <small>Task: ${row.projectTask || 'N/A'} | Total: ${total} hours</small>
                        </div>
                    `;
                    list.appendChild(item);
                });

                container.classList.remove('hidden');
            },

            toggleSelectAllWeekRows() {
                const checkboxes = document.querySelectorAll('.week-row-checkbox');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !allChecked);
            },

            copySelectedRows() {
                const weekStart = document.getElementById('weekSelector').value;
                if (!weekStart) return;

                const sourceWeek = this.data.weeks[weekStart];
                const currentWeek = this.data.weeks[this.currentWeekStart];

                const checkboxes = document.querySelectorAll('.week-row-checkbox:checked');
                if (checkboxes.length === 0) {
                    alert('Please select at least one row to copy');
                    return;
                }

                const includeHours = document.getElementById('includeHours').checked;

                checkboxes.forEach(checkbox => {
                    const rowIndex = parseInt(checkbox.dataset.rowIndex);
                    const sourceRow = sourceWeek.rows[rowIndex];

                    if (sourceRow) {
                        const newRow = JSON.parse(JSON.stringify(sourceRow));
                        newRow.id = 'row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                        if (!includeHours) {
                            newRow.hours = { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0 };
                        }

                        currentWeek.rows.push(newRow);
                        currentWeek.sortState.originalOrder.push(newRow.id);
                    }
                });

                this.render();
                this.saveData();
                this.closeCopyFromWeekModal();

                alert(`Successfully copied ${checkboxes.length} row(s) to current week`);
            },

            // ==================== ADD PAST ROW (FUZZY SEARCH) ====================
            allPastRows: [],
            filteredPastRows: [],
            pastRowSearchTimeout: null,

            showAddPastRow() {
                const modal = document.getElementById('addPastRowModal');
                this.loadAllUniqueRows();
                document.getElementById('pastRowSearch').value = '';
                modal.classList.add('active');
                // Focus search input
                setTimeout(() => {
                    document.getElementById('pastRowSearch').focus();
                }, 100);
            },

            closeAddPastRowModal() {
                document.getElementById('addPastRowModal').classList.remove('active');
            },

            loadAllUniqueRows() {
                // Aggregate all rows from all weeks
                const allRows = [];
                Object.keys(this.data.weeks).forEach(weekStart => {
                    const week = this.data.weeks[weekStart];
                    if (week.rows) {
                        week.rows.forEach(row => allRows.push(row));
                    }
                });

                // Deduplicate by project+projectTask+description combo
                const uniqueMap = new Map();
                allRows.forEach(row => {
                    const key = `${(row.project || '').toLowerCase()}|${(row.projectTask || '').toLowerCase()}|${(row.description || '').toLowerCase()}`;
                    // Only include rows that have at least a project
                    if (!uniqueMap.has(key) && row.project) {
                        uniqueMap.set(key, {
                            project: row.project || '',
                            projectTask: row.projectTask || '',
                            cbs: row.cbs || '',
                            role: row.role || '',
                            type: row.type || '',
                            description: row.description || ''
                        });
                    }
                });

                // Store for filtering
                this.allPastRows = Array.from(uniqueMap.values());
                this.filteredPastRows = [...this.allPastRows];

                // Initial render
                this.renderPastRows();
            },

            filterPastRows() {
                const query = document.getElementById('pastRowSearch').value.trim();

                // Debounce search (300ms)
                clearTimeout(this.pastRowSearchTimeout);
                this.pastRowSearchTimeout = setTimeout(() => {
                    if (!query) {
                        // No search - show all
                        this.filteredPastRows = [...this.allPastRows];
                    } else {
                        // Fuzzy search using Fuse.js
                        const fuse = new Fuse(this.allPastRows, {
                            keys: ['project', 'projectTask', 'description'],
                            threshold: 0.4, // 0.0 = exact, 1.0 = match anything
                            ignoreLocation: true
                        });
                        this.filteredPastRows = fuse.search(query).map(result => result.item);
                    }

                    this.renderPastRows();
                }, 300);
            },

            renderPastRows() {
                const list = document.getElementById('pastRowsList');
                const countSpan = document.getElementById('pastRowsCount');

                if (this.filteredPastRows.length === 0) {
                    list.innerHTML = '<p style="padding: 20px; text-align: center;">No matching rows found</p>';
                    countSpan.textContent = '';
                    return;
                }

                countSpan.textContent = `${this.filteredPastRows.length} row${this.filteredPastRows.length !== 1 ? 's' : ''} found`;

                list.innerHTML = '';
                this.filteredPastRows.forEach((row, index) => {
                    const item = document.createElement('div');
                    item.className = 'week-row-item';
                    item.innerHTML = `
                        <input type="checkbox" class="past-row-checkbox" data-row-index="${index}">
                        <div class="week-row-details">
                            <strong>${row.project || '(No project)'}</strong>
                            <small>Task: ${row.projectTask || 'N/A'} | Desc: ${row.description || 'N/A'}</small>
                        </div>
                    `;
                    list.appendChild(item);
                });
            },

            toggleSelectAllPastRows() {
                const checkboxes = document.querySelectorAll('.past-row-checkbox');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !allChecked);
            },

            addSelectedPastRows() {
                const checkboxes = document.querySelectorAll('.past-row-checkbox:checked');
                if (checkboxes.length === 0) {
                    alert('Please select at least one row to add');
                    return;
                }

                const currentWeek = this.data.weeks[this.currentWeekStart];

                checkboxes.forEach(checkbox => {
                    const rowIndex = parseInt(checkbox.dataset.rowIndex);
                    const sourceRow = this.filteredPastRows[rowIndex];

                    if (sourceRow) {
                        // Create new row with same fields but zero hours
                        const newRow = this.createEmptyRow();
                        newRow.project = sourceRow.project;
                        newRow.projectTask = sourceRow.projectTask;
                        newRow.cbs = sourceRow.cbs;
                        newRow.role = sourceRow.role;
                        newRow.type = sourceRow.type;
                        newRow.description = sourceRow.description;

                        currentWeek.rows.push(newRow);
                        currentWeek.sortState.originalOrder.push(newRow.id);
                    }
                });

                this.render();
                this.saveData();
                this.closeAddPastRowModal();

                alert(`Added ${checkboxes.length} row(s) to current week`);
            }
        };

        // ==================== LIGHTBOX FUNCTIONALITY ====================
        function openLightbox(imgElement) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            lightboxImg.src = imgElement.src;
            lightboxImg.alt = imgElement.alt;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close lightbox on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLightbox();
            }
        });

        // Initialize app when page loads
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
            initFAQSearch();
        });

        // ==================== FAQ SEARCH FUNCTIONALITY ====================
        function initFAQSearch() {
            const searchInput = document.getElementById('faqSearch');
            if (!searchInput) return;

            const faqItems = document.querySelectorAll('.faq-item');

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();

                faqItems.forEach(item => {
                    const question = item.querySelector('.faq-question').textContent.toLowerCase();
                    const answer = item.querySelector('.faq-answer').textContent.toLowerCase();
                    const keywords = item.dataset.keywords || '';

                    const matches = question.includes(searchTerm) ||
                                  answer.includes(searchTerm) ||
                                  keywords.toLowerCase().includes(searchTerm);

                    item.classList.toggle('hidden', !matches && searchTerm !== '');
                });
            });
        }
    </script>
</body>
</html>
